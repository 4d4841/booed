<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="mg-data.html">
<link rel="import" href="mg-common-styles.html">

<dom-module id="mg-image-editor">
  <template strip-whitespace>
      <custom-style>
    <style include="mg-common-styles iron-flex iron-flex-alignment">

      :host {
        display: none;
        position: absolute;
        width: 0;
        height: 0;
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
        @apply(--layout-center);
        background-color: black;
        opacity: 0;
        transition: opacity 0.25s;
        z-index:-1;
      }

      :host([active]) {
        display: block;
        position: fixed;
        z-index:1000;
        width:100%;
        height:100%;
        top: 0;
        left: 0;
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
        @apply(--layout-center);
      }

      .image-info {
        color: lightgray;
        position: absolute;
        top: 0;
        left: 0;
      }

      #thumbnail {
        pointer-events: none;
        border-radius: 5px;
        overflow: hidden;
        margin: 5px;
        border: 1px solid gray;
      }

      #thumbnail-balloon {
        display: none;
        position: absolute;
        z-index: 10;
        transition: width 1s, height 1s;
      }

      .control-panel {
        position: absolute;
        top: 5px;
        right: 5px;
        width: calc(100% - 10px);
      }

      .edit-buttons {
        color: lightgray;
      }

      .edit-buttons paper-icon-button[icon=photo-size-select-large] {
        color: lightgray;
      }

      .thumbnail-panel-buttons paper-icon-button[icon=close],
      .edit-buttons paper-icon-button[icon=close][edited] {
        color: red;
      }

      .thumbnail-panel-buttons paper-icon-button[icon=done],
      .edit-buttons paper-icon-button[icon=done][edited] {
        color: green;
      }

      .edit-buttons paper-icon-button:active {
        color: white;
      }

      .navigator-buttons paper-icon-button {
        color: white;
      }

      #view {
        background-size: contain;
        pointer-events: none;
      }

      /*
      #image-container {
        height: calc(100% - 120px);
        width: calc(100% - 60px);
        border: 1px solid red;
        pointer-events: none;
      }
      */


    </style>
      </custom-style>

    <div class="image-info" hidden$="[[loading]]">
      <template is="dom-if" if="[[!data.item]]">
        <span>clipboard data<iron-icon style="--iron-icon-height:15px" icon="help"></iron-icon>
          <paper-tooltip>
            editing clipboard data is not associated with an item until
            pasting into an item triggers the server syncing.
            until then all the modifications have hitherto been kept
            locally within the clipboard.
          </paper-tooltip>
        </span><br>
      </template>
      <!--
        <template is="dom-if" if="[[data.name]]"> name: [[data.name]] <br> </template>
        width: [[imagewidth]]<br>
        height: [[imageheight]]<br>
      -->
    </div>
    <div class="control-panel horizontal layout justified">
      <div style="width:120px"></div>
      <div class="navigator-buttons" hidden$="{{_hidesNavigator(before,data)}}">
        <paper-icon-button id="skip-previous" icon="skip-previous" on-tap="_setPreviousData" hidden$="[[!before]]">
        </paper-icon-button>

        <paper-icon-button id="skip-next" icon="skip-next" on-tap="_setNextData" hidden$="[[!after]]">
        </paper-icon-button>
      </div>
      <div class="edit-buttons">

        <paper-icon-button style="overflow:visible" id="update-thumbnail-button" icon="photo-size-select-large" on-tap="_openThumbnailDialog">
        </paper-icon-button>

        <paper-icon-button id="save-button" icon="done" on-tap="_deactivateSave" edited$="{{edited}}">
        </paper-icon-button>

        <paper-icon-button id="close-button" icon="close" on-tap="_deactivateClose" edited$="{{edited}}">
        </paper-icon-button>

        <paper-tooltip for="update-thumbnail-button">Update thumbnail</paper-tooltip>
        <paper-tooltip for="close-button">Close</paper-tooltip>
        <paper-tooltip for="save-button">Save changes</paper-tooltip>
      </div>
    </div>

    <template is="dom-if" if="[[loading]]">
      <img style="position:absolute" width="200px" height="200px" src="/images/logo-pumpkin-bouncing.svg">
    </template>

    <mg-balloon id="thumbnail-balloon"
      no-overlap
      vertical-align="top"
      dynamic-align
      horizontal-align="auto"
    > <!--<div class="self-center" id="thumbnail"></div>-->
      <!--<img src="/images/logo-pumpkin-bouncing.svg" class="self-center" id="thumbnail">-->
      <mg-image
        id="thumbnail"
        src="/images/logo-pumpkin-bouncing.svg"
        class="self-center"
        loaded="{{thumbnailLoaded}}"
        roi="[[data.roiThumbnail]]"
      >
      </mg-image>
      <div class="horizontal layout end-justified thumbnail-panel-buttons" style="width:100%">
        <paper-icon-button id="save-thumbnail-button" icon="done" on-tap="_setThumbnail">
        </paper-icon-button>
        <paper-icon-button id="close-thumbnail-panel" icon="close" on-tap="_closeThumbnailPanel">
        </paper-icon-button>
      </div>
    </mg-balloon>
    <paper-tooltip for="save-thumbnail-button">สร้างทั้มเนลใหม่</paper-tooltip>


    <svg
      xmlns:svg="http://www.w3.org/2000/svg"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      id="view"
      version="1.1"
      viewBox="0 0 200 200"
      preserveAspectRatio="none"
      width="0"
      height="0"
      overflow="visible"
      hidden$="[[loading]]">

      <defs>
        <path id="chevrons" d="M -2.6,4.6 -7.2,0 -2.6,-4.6 -4,-6 -10,0 -4,6 Z M 2.6,4.6 7.2,0 2.6,-4.6 4,-6 10,0 4,6 Z" style$="[[_styleArrow(tracking)]]"/>
        <path id="chevron" d="M -2.6,4.6 -7.2,0 -2.6,-4.6 -4,-6 -10,0 -4,6 Z" style$="[[_styleArrow(tracking)]]"/>
        <path id="lock" d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"></path>
      </defs>
      <use xlink:href="#lock" transform$="[[_translateArrows(scaleFactor,tracking,imageWidth,imageHeight,dataLeft,dataTop,0,0.8)]]" style$="[[_styleLock(scaleFactor,tracking,showsAspectLock)]]"/>


      <path d$="[[rPath]]" style$="[[_styleBorder(scaleFactor,tracking)]]"/>
      <path d$="[[rPathInner]]" style$="[[_styleBorderOver(scaleFactor,tracking,showsAspectLock)]]"/>

      <use id="chevrontop" xlink:href="#chevron" transform$="[[_translateArrows(scaleFactor,tracking,imageWidth,imageHeight,dataMidW,dataTop,'top')]]" />
      <use id="chevronleft" xlink:href="#chevron" transform$="[[_translateArrows(scaleFactor,tracking,imageWidth,imageHeight,dataLeft,dataMidH,'left')]]" />
      <use id="chevronbottom" xlink:href="#chevron" transform$="[[_translateArrows(scaleFactor,tracking,imageWidth,imageHeight,dataMidW,dataBottom,'bottom')]]" />
      <use id="chevronright" xlink:href="#chevron" transform$="[[_translateArrows(scaleFactor,tracking,imageWidth,imageHeight,dataRight,dataMidH,'right')]]" />

    </svg>

  </template>
  <script>

/* TODO */
/* - Allows resetting ROIs completely. */
/* - Allows multiple ROIs for any purpose. (eg. for pan-scan animation,temporary) */
/* - ROIs should only be created by an editing attempt. */
/* - Allows representations to have other representations as src. */

    class MGImageEditor extends Polymer.GestureEventListeners(
      Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)
    ) {
      static get is() { return 'mg-image-editor'; }

      static get properties() { return {
        data: {
          type: Object,
          notify: true,
          observer: '_dataChanged',
        },

        rep: {
          type: String,
          notify: true,
          observer: '_repChanged',
        },

        src: {
          type: String,
          observer: '_srcChanged',
          value: null,
        },

        thumbnailLoaded: {
          type: Boolean,
          value: false,
          observer: '_thumbNailLoaded',
        },

        active: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },

        edited: {
          type: Boolean,
          value: false,
        },

        imageWidth: { type: Number, value: 0 },
        imageHeight: { type: Number, value: 0 },
        viewWidth: { type:Number, value: 0 },
        viewHeight: { type:Number, value: 0 },

        dataTop: {type:Number, value: 0},
        dataLeft: {type:Number, value: 0},
        dataWidth: {type:Number, value: 1},
        dataHeight: {type:Number, value: 1},
        dataMidH: {type:Number, value: 0.5},
        dataMidW: {type:Number, value: 0.5},

        scaleFactor: { type: Number, value: 1 },
        rPath: {
          type: String,
          value: "M 0 0 v 0 h 0 v 0 Z",
        },

        loading: Boolean,

        tracking: {
          type: Object,
          value: null,
        },

        imageLoader: Object,

      }}

      static get observers() { return [
        '_editorRectChanged(dataLeft, dataTop, dataWidth, dataHeight, imageWidth, imageHeight)',
        '_dataRectChanged(data.roi)',
        '_updateTitle(active, data.name, imageWidth, imageHeight)',
        '_dataThumbnailChanged(data.thumbnail)',
      ]}

      _hidesNavigator(before, data) {
        if (before == data) return true;
        return false;
      }

      _updateTitle(a, n,w,h) {
        if (a && !this._OldTitle) {
          this._OldTitle = document.title;
        }
        if (!a && this._OldTitle) {
          document.title = this._OldTitle;
          delete this._OldTitle;
        }

        if (w && h && this._OldTitle) {
          document.title = `${n} (${w}×${h}) - Booed`;
        }
      }

      _dataRectChanged(roi) {
        if (roi) {
          this.setProperties({
            dataLeft: roi[0],
            dataTop: roi[1],
            dataWidth: roi[2],
            dataHeight: roi[3],
          });
        } else {
          this.setProperties({
            dataLeft: 0,
            dataTop: 0,
            dataWidth: 1,
            dataHeight: 1,
          });
        }
      }

      _editorRectChanged(l,t,w,h,iw,ih) {
        if (!this.data) {
          return;
        }

        this.setProperties({
          dataRight: l + w,
          dataBottom: t + h,
          dataMidW: l + w/2,
          dataMidH: t + h/2,
          rPath: `M 0 0 v ${ih} h ${iw} v -${ih} Z M ${l*iw} ${t*ih} h ${w*iw} v ${h*ih} h -${w*iw} Z`,
          rPathInner: `M ${l*iw} ${t*ih} h ${w*iw} v ${h*ih} h -${w*iw} Z`,
        });

      }

      _styleLock(lw,tracking,lock) {
        return lock
          ? tracking ? 'fill:none;stroke:none' : 'fill:orange;stroke-width:'+lw+';stroke:orange);'
          : 'fill:none;stroke:none';
      }

      _styleBorderOver(lw,tracking,lock) {
        return tracking ? 'fill:none;stroke:none' : 'fill:none;stroke-width:'+lw*1.3+';stroke:'+(lock?'orange':'white')+';stroke-dasharray:'+lw*3+','+lw*3;
      }

      _styleBorder(lw,tracking) {
        lw*=1.3;
        return tracking ? 'fill:rgba(0,0,0,0.9);stroke:none' : 'fill:none;stroke-width:'+lw*1.3+';stroke:black';
      }

      _styleArrow(tracking) {
        return tracking ? 'fill:rgba(255,255,255,0.3);stroke:none' : 'fill:white;stroke-width:1;stroke:black';
      }

      _translateArrows(s,t,w,h,x,y,r,ss) {
        ss = ss || 1;
        x = x || 0;
        y = y || 0;
        let xlink = "http://www.w3.org/1999/xlink";
        switch(r) {
          case 'top':
            r = t ? 90 : 270;
            this.$.chevrontop.setAttributeNS(xlink, "href",
              y > 0 && !t ? '#chevrons' : y == 0 && t ? '' : '#chevron');
          break;
          case 'left':
            r = t ? 0 : 180;
            this.$.chevronleft.setAttributeNS(xlink, "href",
              x > 0 && !t ? '#chevrons' : x == 0 && t  ? '' : '#chevron');
            break;
          case 'bottom':
            r = t ? 270 : 90;
            this.$.chevronbottom.setAttributeNS(xlink, "href",
              y < 1 && !t ? '#chevrons' : y == 1 && t  ? '' : '#chevron');
            break;
          case 'right':
            r = t ? 180 : 0;
            this.$.chevronright.setAttributeNS(xlink, "href",
              x < 1 && !t ? '#chevrons' : x == 1 && t  ? '' : '#chevron');
            break;
          default: r = r || 0;
        }

        let ret = `translate(${x*w},${y*h})`;
        if (r) ret += ` rotate(${r})`;
        ret+= ` scale(${1.2*s*ss})`;

        return ret;
      }

      connectedCallback(){
        super.connectedCallback();
        this.addEventListener('iron-resize', e => {
          this._setImageWH( this.imageWidth, this.imageHeight );
        },true);
        Polymer.Gestures.addListener(this, 'track', e => this._onTrack(e));

        document.addEventListener('keydown', e => {
          if (this.active) {
            if (!e.ctrlKey) {
              e.preventDefault();
            }

            switch(e.key) {
              case 'ArrowLeft':
                this.set('data',this.before);
                break;
              case 'ArrowRight':
                this.set('data',this.after);
                break;
              case 'Control':
                this.set('showsAspectLock', true);
                this._KeepAspect = this.dataWidth/this.dataHeight;
                break;
            }
          }
        });

        document.addEventListener('keyup', e => {
          if (this.active) {
            if (!e.ctrlKey) {
              e.preventDefault();
            }

            switch(e.key) {
              case 'Escape':
                e.preventDefault();
                this._deactivateClose(e);
              break;
              case 'Control':
                this.set('showsAspectLock', false);
                delete this._KeepAspect;
                break;
            }
          }
        });

      }

      _setImageWH(w,h) {
        if (!w || !h) return;

        let vw = this.clientWidth - 60;
        let vh = this.clientHeight - 120;

        if (vw < 0 || vh < 0) return;

        if (w/h > vw/vh) {
          vh = vw * h/w;
        } else {
          vw = vh * w/h;
        }

        this.setProperties({
          scaleFactor:  w/vw,
          viewWidth: vw,
          viewHeight: vh,
          imageWidth: w,
          imageHeight: h,
          _EW: 20/vw,
          _EH: 20/vh,
        });

        this.$.view.setAttribute('width', vw);
        this.$.view.setAttribute('height', vh);
        this.$.view.setAttribute('viewBox',`0 0 ${w} ${h}`);

      }

      _onTrack(e) {
        let originalTarget = e.originalTarget || e.path[0];
        if (originalTarget != this && originalTarget != this.$.view) return;
        let viewBB = this.$.view.getBoundingClientRect();

        /* It will store 0..1 in database */
        let ax = (e.detail.x - viewBB.left) / this.viewWidth;
        let ay = (e.detail.y - viewBB.top) / this.viewHeight;
        let ew = this._EW;
        let eh = this._EH;
        let ddx = e.detail.ddx / this.viewWidth;
        let ddy = e.detail.ddy / this.viewHeight;

        switch (e.detail.state) {
          case 'start':
            /* Hack to prevent tracking locked into some kind of drag mode with a double-clicking */
            e.preventDefault();

            this.tracking = {
              ax: ax, ay: ay,
              ll:this.dataLeft, tt: this.dataTop,
              ww: this.dataWidth, hh: this.dataHeight,
              l: 0, t: 0, w: 0, h: 0,
            };

            if (ax >= this.dataLeft + ew && ax < this.dataRight - ew
              && ay >= this.dataTop + eh && ay < this.dataBottom - eh) {
              /* Mousedown in the middle */
              this.tracking.l = 1;
              this.tracking.t = 1;
            } else {
              if (ax < this.dataLeft + ew) {
                this.tracking.l = 1;
                this.tracking.w = -1;
              } else if (ax >= this.dataRight - ew) {
                this.tracking.w = 1;
              }

              if (ay < this.dataTop + eh) {
                this.tracking.t = 1;
                this.tracking.h = -1;
              } else if (ay >= this.dataBottom - eh) {
                this.tracking.h = 1;
              }
            }

            break;
          case 'end': {
            this.set('tracking', null);
            this.set('edited',true);
            //this.set('data.roi',[this.dataLeft,this.dataTop,this.dataWidth,this.dataHeight]);
            delete this._KeepAspect;

          } break;
          case 'track': {
            let dx = ax - this.tracking.ax;
            let dy = ay - this.tracking.ay;

            /* XXXX hack to clear selection */
            if ( document.selection ) {
              document.selection.empty();
            } else if ( window.getSelection ) {
              window.getSelection().removeAllRanges();
            }

            let ll = this.tracking.ll + this.tracking.l * dx;
            let tt = this.tracking.tt + this.tracking.t * dy;
            let ww = this.tracking.ww + this.tracking.w * dx;
            let hh = this.tracking.hh + this.tracking.h * dy;

            if (ll < 0) {
              ww = ww + ll; ll = 0;
            } else if (ll + ww > 1) {
              ww = 1 - ll;
            }

            if (tt < 0) {
              hh = hh + tt; tt = 0;
            } else if (tt + hh > 1) {
              hh = 1 - tt;
            }

            if (this._KeepAspect) {
              if (this.tracking.l == 1 && this.tracking.t == 1
                && this.tracking.w == 0 && this.tracking.h == 0) {

                if (ll < 0) {
                  ll = 0;
                } else if (ll + this.tracking.ww > 1) {
                  ll = 1 - this.tracking.ww;
                }
                if (tt < 0) {
                  tt = 0;
                } else if (tt + this.tracking.hh > 1) {
                  tt = 1 - this.tracking.hh;
                }
                ww = this.tracking.ww;
                hh = this.tracking.hh;

              } else if (this.tracking.l == 1 && this.tracking.w == -1
                && this.tracking.t == 1 && this.tracking.h == -1 ) {
                if (ww/hh < this._KeepAspect) {
                  hh = ww / this._KeepAspect;
                  tt = this.tracking.tt + this.tracking.hh - hh;
                } else {
                  ww = hh * this._KeepAspect;
                  ll = this.tracking.ll + this.tracking.ww - ww;
                }
              } else if (this.tracking.l == 0 && this.tracking.w == 1
                && this.tracking.t == 1 && this.tracking.h == -1 ) {
                if (ww/hh < this._KeepAspect) {
                  hh = ww / this._KeepAspect;
                  tt = this.tracking.tt + this.tracking.hh - hh;
                } else {
                  ww = hh * this._KeepAspect;
                }
              } else if (this.tracking.l == 1 && this.tracking.w == -1
                && this.tracking.t == 0 && this.tracking.h == 1 ) {
                if (ww/hh < this._KeepAspect) {
                  hh = ww / this._KeepAspect;
                } else {
                  ww = hh * this._KeepAspect;
                  ll = this.tracking.ll + this.tracking.ww - ww;
                }
              } else if (this.tracking.w == 1 && this.tracking.h == 1) {
                if (ww/hh < this._KeepAspect) {
                  hh = ww / this._KeepAspect;
                } else {
                  ww = hh * this._KeepAspect;
                }
              } else if (this.tracking.w) {
                tt -= ((ww / this._KeepAspect) - hh) * 0.5;
                hh = ww / this._KeepAspect;

                if (tt < 0) { tt = 0; }
                if (tt + hh > 1) { tt = 1 - hh; }
                if (tt < 0) {
                  hh = 1;
                  ww = hh * this._KeepAspect;
                  ll = this.tracking.ll + this.tracking.ww - ww;
                }

              } else if (this.tracking.h) {
                ll -= ((hh * this._KeepAspect) - ww) * 0.5;
                ww = hh * this._KeepAspect;

                if (ll < 0) { ll = 0; }
                if (ll + ww > 1) { ll = 1 - ww; }
                if (ll < 0) {
                  ww = 1;
                  hh = ww / this._KeepAspect;
                  tt = this.tracking.tt + this.tracking.hh - hh;
                }
              }
            }

            /* XXX */

            ll = ll > 1 ? 1 : ll < 0 ? 0 : ll;
            ww = ww < ew*3 ? ew*3 : ll + ww > 1 ? 1 - ll : ww;
            if (ll + ww > 1) {ll = 1 - ww;}

            tt = tt > 1 ? 1 : tt < 0 ? 0 : tt;
            hh = hh < eh*3 ? eh*3 : tt + hh > 1 ? 1 - tt : hh;
            if (tt + hh > 1) {tt = 1 - hh;}

            this.setProperties({
              dataLeft: ll,
              dataTop: tt,
              dataWidth: ww,
              dataHeight: hh,
            });

          } break;
        }
      }

      _dataThumbnailChanged(thumbnail) {
        thumbnail && MHA.registerRepresentation(thumbnail, {
          src: (key,src) => { if (key == this.data.thumbnail) {
            this.$.thumbnail.src = src;
            /* XXX balloon should wrap refit() to have this automatic */
            Polymer.Async.timeOut.run(() => {
              this.$['thumbnail-balloon'].refit();
            }, 0);
          }}
        });
      }

      _thumbNailLoaded(loaded) {
        if (loaded) {
          let area = (250*250);
          let tw = this.$.thumbnail.naturalWidth;
          let th = this.$.thumbnail.naturalHeight;

          if (this.data && this.data.roiThumbnail) {
            tw *= this.data.roiThumbnail[2];
            th *= this.data.roiThumbnail[3];
          }

          let w = Math.ceil(Math.sqrt(area * tw/th));
          let h = Math.ceil(area / w);

          this.$.thumbnail.setProperties({
            width: w,
            height: h,
          });
        }
      }

      _dataChanged(data) {
        this.set('edited',false);
        if (data) {
          this.set('active',true);
          this.style.opacity = 1;
          this.set('loading', true);

          data.roi || this.set('data.roi', [0,0,1,1] );
          this.setProperties({
            rep: data.rep,
            dataLeft: data.roi[0],
            dataTop: data.roi[1],
            dataWidth: data.roi[2],
            dataHeight: data.roi[3],
          });

        } else {
          this.set('rep', null);
          this.set('active',false);
        }
      }

      _repChanged(rep) {
        if (rep) {
          MHA.registerRepresentation(rep, {
            src: (key,src) => { if (key == this.rep) {
/***

Storage Note: To allow pulling image back from storage, it needs to set CORS using gsutil. eg.

gsutil cors set <( echo '[{"maxAgeSeconds": 3600, "method": ["GET"], "origin": ["https://be-booed.firebaseapp.com", "http://localhost:5000"], "responseHeader": ["Content-Type"]}]' ) gs://be-booed.appspot.com

***/
              this.set('imageLoader', new Image());
              this.imageLoader.crossOrigin="anonymous";
              this.imageLoader.onload = e => {
                this._setImageWH(this.imageLoader.naturalWidth,this.imageLoader.naturalHeight);
                this.set('src',this.imageLoader.src);
                this.set('loading', false);
              };
              this.imageLoader.src = src;
            }}
          });
        } else {
          this.set('src',null);
          this.set('imageLoader', null);

          this.$.view.setAttribute('viewBox','0 0 200 200');
          this.$.view.setAttribute('width', 200);
          this.$.view.setAttribute('height', 200);
        }
      }

      _srcChanged(src) {
        this.$.view.style.backgroundImage = `url(${src})`;
      }

      _deactivateClose(e) {
        this.style.opacity = 0;
        Polymer.Async.timeOut.run(() => {
          this.set('data',null);
        }, 250);
      }

      _deactivateSave(e) {
        let roi = (this.dataLeft == 0 && this.dataTop == 0 && this.dataWidth == 1 && this.dataHeight == 1)
          ? null
          : [this.dataLeft,this.dataTop,this.dataWidth,this.dataHeight];
        this.set('data.roi', roi);
        /* Update database */
        let itemKey = this.data.item;
        if (itemKey) {

            MHA.DB.ref().update({['home/'+MHA.AU.currentUser.uid+'/items/'+itemKey+'/images/'+this.data.key+'/roi']: roi}, error => {
              error && console.error("ERR",error);
            });
        }

        this.set('edited',false);
        if (!this.after)
          this._deactivateClose(e)
      }

      _openThumbnailDialog(e) {

        this.dispatchEvent(new CustomEvent('close-contextual-menu', {
          bubbles: true, composed: true, detail:{sender:this}
        }));

        if (this.$['thumbnail-balloon'].visible) {
          this.$['thumbnail-balloon'].close();
          return;
        }

        this.$['thumbnail-balloon'].positionTarget = this.$['update-thumbnail-button'];
        this.$['thumbnail-balloon'].open();
        this.$['thumbnail-balloon'].focus();
      }

      _closeThumbnailPanel(e) {
        this.$['thumbnail-balloon'].close();
      }

      _setThumbnail(e) {
        let itemKey = this.data.item;
        if (!itemKey) {
          /* Does not generate icon if editing clipboard data (no itemKey).
           * Stores roiThumbnail which will be used to generate the thumbnail
           * when pasting and replaces thumbnail rep with the image rep so it
           * will regenerate thumbnail from the original image.
           */

          this.set('data.roiThumbnail',[this.dataLeft,this.dataTop,this.dataWidth,this.dataHeight]);
          this.set('data.thumbnail',this.data.rep);

          return;
        }

        let imageKey = this.data.key;
        console.assert(imageKey, "No image key?!?");

        /* Generating thumbnail with canvas */
        let area = (250*250);

        let tl = this.imageWidth * this.dataLeft;
        let tt = this.imageHeight * this.dataTop;
        let tw = this.imageWidth * this.dataWidth;
        let th = this.imageHeight * this.dataHeight;

        let w = Math.ceil(Math.sqrt(area * tw/th));
        let h = Math.ceil(area / w);

        let canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;

        console.assert(this.imageLoader, "No Image in this!?");

        canvas.getContext('2d').drawImage(this.imageLoader, tl, tt, tw, th, 0, 0, w, h);
        canvas.toBlob(thumbnailBlob => {
          MHA.registerRepresentation(thumbnailBlob, {
            complete: (thumbnailKey,complete) => {
              /* XXX verify current thumbnailKey */

              MHA.assignItem( itemKey, {
                /* Reset roiThumbnail since it has been baked */
                images: { [imageKey]: { thumbnail: thumbnailKey, roiThumbnail: null } },
              });

              let uid = MHA.AU.currentUser.uid;
              let registerData = {
                ['representations/'+thumbnailKey+'/uid']: uid,
                ['home/'+uid+'/items/'+itemKey+'/images/'+imageKey+'/thumbnail']: thumbnailKey,
              };

              MHA.DB.ref().update(registerData, error => {
                error && console.error("ERR",error);
              });

            },
          });
        }, 'image/jpeg',0.8);

      }

      _setPreviousData(e) {
        this.set('data',this.before);
      }

      _setNextData(e) {
        this.set('data',this.after);
      }

    }

    customElements.define(MGImageEditor.is, MGImageEditor);
  </script>
</dom-module>
