<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="mg-common-styles.html">

<dom-module id="mg-image-editor">
  <template strip-whitespace>
      <custom-style>
    <style include="mg-common-styles iron-flex iron-flex-alignment">

      :host {
        display: none;
        position: absolute;
        width: 0;
        height: 0;
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        @apply(--layout-center);
        background-color: black;
        opacity: 0;
        transition: opacity 0.25s;
        z-index:-1;
      }

      :host([active]) {
        display: block;
        position: fixed;
        z-index:1000;
        width:100%;
        height:100%;
        top: 0;
        left: 0;
        display: block;
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        @apply(--layout-center);
      }

      .image-info {
        color: lightgray;
        position: absolute;
        top: 0;
        left: 0;
      }

      .control-buttons {
        position: absolute;
        top: 5px;
        right: 5px;
        color: lightgray;
      }

      #thumbnail {
        pointer-events: none;
        border-radius: 5px;
        overflow: hidden;
        margin: 5px;
      }

      #thumbnail-balloon {
        display: none;
        position: absolute;
        z-index: 10;
      }

      .control-buttons paper-icon-button[icon=photo-size-select-large] {
        color: lightgray;
      }

      .thumbnail-panel-buttons paper-icon-button[icon=close],
      .control-buttons paper-icon-button[icon=close] {
        color: red;
      }

      .thumbnail-panel-buttons paper-icon-button[icon=done],
      .control-buttons paper-icon-button[icon=done] {
        color: green;
      }

      .control-buttons paper-icon-button:active {
        color: white;
      }

      #view {
        background-size: contain;
      }

      /*
      #image-container {
        height: calc(100% - 120px);
        width: calc(100% - 60px);
        border: 1px solid red;
        pointer-events: none;
      }
      */


    </style>
      </custom-style>

    <div class="image-info" hidden$="[[loading]]">
      <template is="dom-if" if="[[!data.item]]">
        <span>Clipboard Data<iron-icon style="--iron-icon-height:15px" icon="help"></iron-icon>
          <paper-tooltip>
            Editing clipboard data is not associated with an item until
            pasting into an item triggers the server syncing.
            Until then all the modifications have hitherto been kept
            locally within the clipboard.
          </paper-tooltip>
        <span><br>
      </template>
      <!--
        <template is="dom-if" if="[[data.name]]"> Name: [[data.name]] <br> </template>
        Width: [[imageWidth]]<br>
        Height: [[imageHeight]]<br>
      -->
    </div>
    <div class="control-buttons">
      <paper-icon-button id="skip-previous" icon="skip-previous" on-tap="_setPreviousData" hidden$="[[!before]]">
      </paper-icon-button>

      <paper-icon-button id="skip-next" icon="skip-next" on-tap="_setNextData" hidden$="[[!after]]">
      </paper-icon-button>

      <paper-icon-button style="overflow:visible" id="update-thumbnail-button" icon="photo-size-select-large" on-tap="_openThumbnailDialog">
      </paper-icon-button>

      <paper-icon-button id="save-button" icon="done" on-tap="_deactivateSave">
      </paper-icon-button>

      <paper-icon-button id="close-button" icon="close" on-tap="_deactivateClose">
      </paper-icon-button>

      <paper-tooltip for="update-thumbnail-button">Update thumbnail</paper-tooltip>
      <paper-tooltip for="close-button">Close</paper-tooltip>
      <paper-tooltip for="save-button">Save changes</paper-tooltip>
    </div>

    <template is="dom-if" if="[[loading]]">
      <img style="position:absolute" width="200px" height="200px" src="/images/logo-pumpkin-bouncing.svg">
    </template>

    <mg-balloon id="thumbnail-balloon"
      no-overlap
      vertical-align="top"
      dynamic-align
      horizontal-align="auto"
      visible="{{thumbShowed}}"
    > <canvas class="self-center" id="thumbnail"></canvas>
      <div class="horizontal layout end-justified thumbnail-panel-buttons" style="width:100%">
        <paper-icon-button id="save-thumbnail-button" icon="done" on-tap="_saveThumbnail">
        </paper-icon-button>
        <paper-icon-button id="close-thumbnail-panel" icon="close" on-tap="_closeThumbnailPanel">
        </paper-icon-button>
      </div>
    </mg-balloon>
    <paper-tooltip for="save-thumbnail-button">สร้างทั้มเนลใหม่</paper-tooltip>


    <svg
       xmlns:svg="http://www.w3.org/2000/svg"
       xmlns="http://www.w3.org/2000/svg"
       xmlns:xlink="http://www.w3.org/1999/xlink"
       id="view"
       version="1.1"
       viewBox="0 0 200 200"
       preserveAspectRatio="none"
       width="0"
       height="0"
       overflow="visible"
       hidden$="[[loading]]">

       <defs>
         <path id="chevrons" d="M -2.6,4.6 -7.2,0 -2.6,-4.6 -4,-6 -10,0 -4,6 Z M 2.6,4.6 7.2,0 2.6,-4.6 4,-6 10,0 4,6 Z" style$="[[_styleArrow(tracking)]]"/>
         <path id="chevron" d="M -2.6,4.6 -7.2,0 -2.6,-4.6 -4,-6 -10,0 -4,6 Z" style$="[[_styleArrow(tracking)]]"/>
       </defs>

       <path d$="[[rPath]]" style$="[[_styleBorder(tracking)]]"/>
       <path d$="[[rPathInner]]" style$="[[_styleBorderInner(tracking)]]"/>

       <use id="chevrontop" xlink:href="#chevron" transform$="[[_translateArrows(scaleFactor,tracking,imageWidth,imageHeight,dataMidW,dataTop,'top')]]" />
       <use id="chevronleft" xlink:href="#chevron" transform$="[[_translateArrows(scaleFactor,tracking,imageWidth,imageHeight,dataLeft,dataMidH,'left')]]" />
       <use id="chevronbottom" xlink:href="#chevron" transform$="[[_translateArrows(scaleFactor,tracking,imageWidth,imageHeight,dataMidW,dataBottom,'bottom')]]" />
       <use id="chevronright" xlink:href="#chevron" transform$="[[_translateArrows(scaleFactor,tracking,imageWidth,imageHeight,dataRight,dataMidH,'right')]]" />

    </svg>

  </template>
  <script>

/* TODO */
/* - Allows resetting ROIs completely. */
/* - Allows multiple ROIs for any purpose. (eg. for pan-scan animation.) */
/* - ROIs should only be created by an editing attempt. */
/* - Recreate thumbnails.*/

    class MGImageEditor extends Polymer.GestureEventListeners(
      Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)
    ) {
      static get is() { return 'mg-image-editor'; }

      static get properties() { return {
        data: {
          type: Object,
          notify: true,
          observer: '_dataChanged',
        },

        rep: {
          type: String,
          notify: true,
          observer: '_repChanged',
        },

        src: {
          type: String,
          observer: '_srcChanged',
          value: null,
        },

        active: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
        },

        imageWidth: { type: Number, value: 0 },
        imageHeight: { type: Number, value: 0 },
        viewWidth: { type:Number, value: 0 },
        viewHeight: { type:Number, value: 0 },

        dataTop: {type:Number, value: 0},
        dataLeft: {type:Number, value: 0},
        dataWidth: {type:Number, value: 1},
        dataHeight: {type:Number, value: 1},
        dataMidH: {type:Number, value: 0.5},
        dataMidW: {type:Number, value: 0.5},

        scaleFactor: { type: Number, value: 1 },
        rPath: {
          type: String,
          value: "M 0 0 v 0 h 0 v 0 Z",
        },

        loading: Boolean,

        tracking: {
          type: Object,
          value: null,
        },

        imageLoader: Object,

      }}

      static get observers() { return [
        '_editorRectChanged(dataLeft, dataTop, dataWidth, dataHeight, imageWidth, imageHeight)',
        '_dataRectChanged(data.roi)',
        '_updateTitle(active, data.name, imageWidth, imageHeight)',
        '_updateCanvas(thumbShowed, loading)',
      ]}

      _updateTitle(a, n,w,h) {
        if (a && !this._OldTitle) {
          this._OldTitle = document.title;
        }
        if (!a && this._OldTitle) {
          document.title = this._OldTitle;
          delete this._OldTitle;
        }

        if (w && h && this._OldTitle) {
          document.title = `${n} (${w}×${h}) - Booed`;
        }
      }

      _dataRectChanged(roi) {
        if (roi) {
          this.setProperties({
            dataLeft: roi[0],
            dataTop: roi[1],
            dataWidth: roi[2],
            dataHeight: roi[3],
          });
        }
      }

      _editorRectChanged(l,t,w,h,iw,ih) {
        if (!this.data) {
          return;
        }

        this.setProperties({
          dataRight: l + w,
          dataBottom: t + h,
          dataMidW: l + w/2,
          dataMidH: t + h/2,
          rPath: `M 0 0 v ${ih} h ${iw} v -${ih} Z M ${l*iw} ${t*ih} h ${w*iw} v ${h*ih} h -${w*iw} Z`,
          rPathInner: `M ${l*iw} ${t*ih} h ${w*iw} v ${h*ih} h -${w*iw} Z`,
        });

      }

      _styleBorder(tracking) {
        return tracking ? 'fill:rgba(0,0,0,0.9);stroke:none' : 'fill:none;stroke-width:1;stroke:black';
      }

      _styleBorderInner(tracking) {
        return tracking ? 'fill:none;stroke:none' : 'fill:none;stroke-width:1;stroke:white;stroke-dasharray:3,3';
      }

      _styleArrow(tracking) {
        return tracking ? 'fill:rgba(255,255,255,0.3);stroke:none' : 'fill:white;stroke-width:1;stroke:black';
      }

      _translateArrows(s,t,w,h,x,y,r) {
        x = x || 0;
        y = y || 0;
        let xlink = "http://www.w3.org/1999/xlink";
        switch(r) {
          case 'top':
            r = t ? 90 : 270;
            this.$.chevrontop.setAttributeNS(xlink, "href",
              y > 0 && !t ? '#chevrons' : y == 0 && t ? '' : '#chevron');
          break;
          case 'left':
            r = t ? 0 : 180;
            this.$.chevronleft.setAttributeNS(xlink, "href",
              x > 0 && !t ? '#chevrons' : x == 0 && t  ? '' : '#chevron');
            break;
          case 'bottom':
            r = t ? 270 : 90;
            this.$.chevronbottom.setAttributeNS(xlink, "href",
              y < 1 && !t ? '#chevrons' : y == 1 && t  ? '' : '#chevron');
            break;
          case 'right':
            r = t ? 180 : 0;
            this.$.chevronright.setAttributeNS(xlink, "href",
              x < 1 && !t ? '#chevrons' : x == 1 && t  ? '' : '#chevron');
            break;
          default: r = r || 0;
        }

        let ret = `translate(${x*w},${y*h})`;
        if (r) ret += ` rotate(${r})`;
        ret+= ` scale(${1.2*s})`;

        return ret;
      }

      connectedCallback(){
        super.connectedCallback();
        this.addEventListener('iron-resize', e => {
          this._setImageWH( this.imageWidth, this.imageHeight );
        },true);
        Polymer.Gestures.addListener(this, 'track', e => this._onTrack(e));
      }

      _setImageWH(w,h) {
        if (!w || !h) return;

        let vw = this.clientWidth - 60;
        let vh = this.clientHeight - 120;

        if (vw < 0 || vh < 0) return;

        if (w/h > vw/vh) {
          vh = vw * h/w;
        } else {
          vw = vh * w/h;
        }

        this.setProperties({
          scaleFactor:  w/vw,
          viewWidth: vw,
          viewHeight: vh,
          imageWidth: w,
          imageHeight: h,
          _EW: 40/vw,
          _EH: 40/vh,
        });

        this.$.view.setAttribute('width', vw);
        this.$.view.setAttribute('height', vh);
        this.$.view.setAttribute('viewBox',`0 0 ${w} ${h}`);

      }

      _onTrack(e) {
        let originalTarget = e.originalTarget || e.path[0];
        if (originalTarget != this && originalTarget != this.$.view) return;
        let viewBB = this.$.view.getBoundingClientRect();

        /* It will store 0..1 in database */
        let ax = (e.detail.x - viewBB.left) / this.viewWidth;
        let ay = (e.detail.y - viewBB.top) / this.viewHeight;
        let ew = this._EW;
        let eh = this._EH;
        let ddx = e.detail.ddx / this.viewWidth;
        let ddy = e.detail.ddy / this.viewHeight;

        switch (e.detail.state) {
          case 'start':
            this.tracking = {l: 0, t: 0, w: 0, h: 0};

            if (ax >= this.dataLeft + ew && ax < this.dataRight - ew
              && ay >= this.dataTop + eh && ay < this.dataBottom - eh) {
              this.tracking.l = 1;
              this.tracking.t = 1;
            } else {
              if (ax < this.dataLeft + ew) {
                this.tracking.l = 1;
                this.tracking.w = -1;
              } else if (ax >= this.dataRight - ew) {
                this.tracking.w = 1;
              }

              if (ay < this.dataTop + eh) {
                this.tracking.t = 1;
                this.tracking.h = -1;
              } else if (ay >= this.dataBottom - eh) {
                this.tracking.h = 1;
              }
            }

            break;
          case 'end': {
            this.set('tracking', null);
            //this.set('data.roi',[this.dataLeft,this.dataTop,this.dataWidth,this.dataHeight]);
          } break;
          case 'track': {

            /* XXXX hack to clear selection */
            if ( document.selection ) {
              document.selection.empty();
            } else if ( window.getSelection ) {
              window.getSelection().removeAllRanges();
            }

            if (this.tracking.l) {
              let l = this.dataLeft + ddx;
              this.set('dataLeft',l > 1 ? 1 : l);
            }
            if (this.tracking.t) {
              let t = this.dataTop + ddy;
              this.set('dataTop', t > 1 ? 1 : t);
            }
            if (this.tracking.w) {
              let w = this.dataWidth + ddx * this.tracking.w;
              this.set('dataWidth', w < 0 ? 0 : w);
            }
            if (this.tracking.h) {
              let h = this.dataHeight + ddy * this.tracking.h;
              this.set('dataHeight', h < 0 ? 0 : h);
            }

            if (this.dataLeft < 0) {
              let w = this.dataWidth + this.dataLeft;
              this.set('dataWidth', w < 0 ? 0 : w);
              this.set('dataLeft', 0);
            } else if (this.dataLeft + this.dataWidth > 1) {
              let w = 1 - this.dataLeft;
              this.set('dataWidth', w < 0 ? 0 : w);
            }

            if (this.dataTop < 0) {
              let h = this.dataHeight + this.dataTop;
              this.set('dataHeight', h < 0 ? 0 : h);
              this.set('dataTop', 0);
            } else if (this.dataTop + this.dataHeight > 1) {
              let h = 1 - this.dataTop;
              this.set('dataHeight', h < 0 ? 0 : h);
            }

          } break;
        }
      }

      _dataChanged(data) {
        if (data) {
          data.roi || this.set('data.roi', [0,0,1,1] );
          this.setProperties({
            rep: data.rep,
            'dataLeft': data.roi[0],
            'dataTop': data.roi[1],
            'dataWidth': data.roi[2],
            'dataHeight': data.roi[3],
          });
        } else {
          this.set('rep', null);
        }
      }

      _repChanged(rep) {
        if (rep) {
          this.set('active',true);
          this.style.opacity = 1;
          this.set('loading', true);
          MGAPP.registerRepresentation(rep, (key,ev,val) => {
            if (key == this.rep) {
/***

Storage Note: To allow pulling image back from storage, it needs to set CORS using gsutil. eg.

gsutil cors set <( echo '[{"maxAgeSeconds": 3600, "method": ["GET"], "origin": ["https://be-booed.firebaseapp.com", "http://localhost:5000"], "responseHeader": ["Content-Type"]}]' ) gs://be-booed.appspot.com

***/
              this.set('imageLoader', new Image());
              this.imageLoader.crossOrigin="anonymous";
              this.imageLoader.onload = e => {
                this._setImageWH(this.imageLoader.naturalWidth,this.imageLoader.naturalHeight);
                this.set('src',this.imageLoader.src);
                this.set('loading', false);
              };
              this.imageLoader.src = val;
            }
          });
        } else {
          this.set('src',null);
          this.set('active',false);
          this.set('imageLoader', null);

          this.$.view.setAttribute('viewBox','0 0 200 200');
          this.$.view.setAttribute('width', 200);
          this.$.view.setAttribute('height', 200);
        }
      }

      _srcChanged(src) {
        this.$.view.style.backgroundImage = `url(${src})`;
      }


      _deactivateClose(e) {
        this.style.opacity = 0;
        Polymer.Async.timeOut.run(() => {
          this.set('data',null);
        }, 250);
      }

      _deactivateSave(e) {
        this.set('data.roi',[this.dataLeft,this.dataTop,this.dataWidth,this.dataHeight]);
        this._deactivateClose(e)
      }

      _updateCanvas(thumbShowed, loading) {
        if (thumbShowed && !loading && this.src) {

          let tl = this.imageWidth * this.dataLeft;
          let tt = this.imageHeight * this.dataTop;
          let tw = this.imageWidth * this.dataWidth;
          let th = this.imageHeight * this.dataHeight;
          let area = (250*250);
          let w = Math.ceil(Math.sqrt(area * tw/th));
          let h = Math.ceil(area / w);

          this.$.thumbnail.style.width = w+'px';
          this.$.thumbnail.style.height = h+'px';

          let canvas = this.$.thumbnail;
          canvas.width = w;
          canvas.height = h;

          console.assert(this.imageLoader, "XXX");
          canvas.getContext('2d').drawImage(this.imageLoader, tl, tt, tw, th, 0, 0, w, h);
          this.$['thumbnail-balloon'].refit();

        }
      }

      _openThumbnailDialog(e) {

        this.dispatchEvent(new CustomEvent('close-contextual-menu', {
          bubbles: true, composed: true, detail:{sender:this}
        }));

        if (this.$['thumbnail-balloon'].visible) {
          this.$['thumbnail-balloon'].close();
          return;
        }

        this.$['thumbnail-balloon'].positionTarget = this.$['update-thumbnail-button'];
        this.$['thumbnail-balloon'].open();
        this.$['thumbnail-balloon'].focus();
      }

      _closeThumbnailPanel(e) {
        this.$['thumbnail-balloon'].close();
      }

      _saveThumbnail(e) {
        this.$.thumbnail.toBlob(blob => {
          let thumbKey = MGAPP.DB.ref('representations').push().key;
          MGAPP.registerRepresentation(thumbKey, (key,ev,val) => {
            switch(ev) {
              case 'src': {
                /*
                MGAPP.assignItem(data.item,{
                  images: {
                    [data.key]: {
                      name: data.name,
                      thumbnail: thumbKey,
                    }
                  },
                });
                */

              } break;
              case 'complete': {

                /* This will contain customizations like ROIs, thumbnail, custom name */
                registerInfo.thumbnail = key;
                /* Published item, Will also contain tags */
                registerImageReps();

              } break;
            }
          }, blob);
        },'image/jpeg',0.8);
      }

      _setPreviousData(e) {
        this.set('data',this.before);
      }

      _setNextData(e) {
        this.set('data',this.after);
      }

    }

    customElements.define(MGImageEditor.is, MGImageEditor);
  </script>
</dom-module>
