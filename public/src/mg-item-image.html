<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="mg-thumbnail.html">

    <dom-module id="mg-item-image">
  <template strip-whitespace>
<style include="mg-common-styles iron-flex iron-flex-alignment">
:host {
  position: relative;
}

:host(.iron-selected) {
  --mg-thumbnail : {
    background-color: tomato;
  };
}

paper-progress {
  position: absolute;
  top: 5px;
  width: calc(100% - 10px);
  pointer-events: none;
  border-radius: 2px;
  z-index:3;
}

.selection-order {
  position: absolute;
  width: 100%;
  height: 100%;
  background-color: rgba(100,40,0,0.4);
  color: white;
  font-size: 60px;
  font-weight: normal;
  text-align: center;
  line-height: 110px;
  text-decoration: none;
}

</style>

<mg-thumbnail
  src="[[src]]"
  roi="[[roi]]"
  icon="[[_formatIcon(item)]]"
  label="[[_formatLabel(item.images, item.name, item.role, language)]]"
  deleted$="[[item.deleted]]"
  placeholder='images/logo-pumpkin-outline-grayout.svg'
  transition="1.5s"
  spinner
> <template is="dom-if" if="{{showSelectionOrder}}">
    <div class="selection-order">
      [[selectionOrder]]
    </div>
  </template>

  <template is="dom-if" if="[[_computeShowProgress(item.progress$)]]">
    <paper-progress
      value="[[item.progress$]]"
    ></paper-progress>
  </template>

  <slot></slot>
</mg-thumbnail>

  </template>
  <script>
class MGItemImage extends MHA.Configurations(MHA.Items(Polymer.Element)) {
  static get is() { return 'mg-item-image'; }

  static get properties() { return {
    item: {
      type: Object,
      observer: '_itemChanged',
    },

    label: String,
    key: String,
    src: String,
    icon: String,
    rep: String,
    roi: Array,

    showProgress: {
      type: Boolean,
      computed: '_computeShowProgress(item.progress$)',
    },

    selectionOrder: String,
    showSelectionOrder: {
      type: Boolean,
      computed: '_computeShowSelectionOrder(selectionOrder)',
    },

  }}

  static get observers() { return [
    '_coverChanged(item.cover)',
    '_thumbnailChanged(item.thumbnail)',
  ]}

  /* Item is an mg-item */
  _coverChanged(cover) {
    if (cover) {
      if (this.item.images[cover]) {
        if (this.item.images[cover].thumbnail) {
          let cachedSrc = false;
          MHA.registerRepresentation(this.item.images[cover].thumbnail, { src: (key,src) => {
            cachedSrc = true;
            this.set('src', src);
          }});
          if (!cachedSrc) {
            this.set('src',undefined);
          }
        }
      } else { /* cover is a rep */
        let cachedSrc = false;
        MHA.registerRepresentation(cover, { src: (key,src) => {
          cachedSrc = true;
          this.set('src', src);
        }});
        if (!cachedSrc) {
          this.set('src',undefined);
        }
      }
    }
  }

  /* Item is an mg-image */
  _thumbnailChanged(thumbnail) {
    if (thumbnail) {
      let cachedSrc = false;
      MHA.registerRepresentation(thumbnail, { src: (key,src) => {
        cachedSrc = true;
        this.set('src', src);
      }});
      if (!cachedSrc) {
        this.set('src',undefined);
      }
    }
  }

  _itemChanged(item,oldItem) {
    //console.log('it', item);
    this.set('src','images/logo-pumpkin-outline-grayout.svg');
  }

  /*
  _thumbnailChanged(repKey) {
    if (repKey) {
      this.set('src',null);
      MHA.registerRepresentation(repKey, { src: (key,src) => {
        if (key == this.thumbnail) this.set('src',src);
      }});
    }
    else {
      this.set('src','images/logo-pumpkin-outline-grayout.svg');
    }
  }
  */

  _computeShowProgress(progress) {
    if (typeof(progress) == "undefined") return false;
    if (progress == 100) return false;
    return true;
  }

  _computeShowSelectionOrder(selectionOrder) {
    if (selectionOrder) return true;
    return false;
  }

  _formatIcon(item) {
    if (item.role) {
      return MGIconForRole(item.role);
    } else if (item.rep) {
      return MGIconForRole('photo');
    }
  }

  _formatLabel(images, str, role) {
    str = str || this.localize('noname');
    return role == 'gallery'
      ? (images ? "Ã—" + Object.entries(images).length : '') +" "+ str
      : str;
  }
}

customElements.define(MGItemImage.is, MGItemImage);
</script>
</dom-module>
