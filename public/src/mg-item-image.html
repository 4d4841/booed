<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="mg-thumbnail.html">

<dom-module id="mg-item-image">
  <template strip-whitespace>
      <custom-style>
    <style include="mg-common-styles iron-flex iron-flex-alignment">
      :host {
        position: relative;
      }

      :host(.iron-selected) {
        --mg-thumbnail : {
          background-color: tomato;
        };
      }

      paper-progress {
        position: absolute;
        top: 5px;
        width: calc(100% - 10px);
        pointer-events: none;
        border-radius: 2px;
        z-index:3;
      }

      .selection-order {
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: rgba(100,40,0,0.4);
        color: white;
        font-size: 60px;
        font-weight: normal;
        text-align: center;
        line-height: 110px;
        text-decoration: none;
      }

      .image-edit-button-icon {
        opacity: 0;
        width: 0px;
        height: 0px;
        position: absolute;
        right: 0;
        top: 3px;
        @apply(--layout-self-end);
        z-index: 3;
        color: white;
        background-color: rgba(0,0,0,0.3);
        box-shadow: inset 1px 1px 1px var(--app-shadow-color);
        border-radius: 25%;
        padding: 3px;
        --iron-icon-width: 20px;
        --iron-icon-height: 20px;
      }

      :host(:hover) .image-edit-button-icon {
        opacity: 1;
        transition: width 0.25s, height 0.5s, opacity 1s;
        width: 30px;
        height: 30px;
      }

      :host(.iron-selected) .image-edit-button-icon {
        opacity: 0;
      }

    </style>
      </custom-style>

  <paper-icon-button icon="mode-edit" class="image-edit-button-icon" on-tap="_onEditImage">
  </paper-icon-button>

  <mg-thumbnail
    src="[[src]]"
    icon="photo"
    label="[[name]]"
    deleted$="[[deleted]]"
    placeholder='images/logo-pumpkin-outline-grayout.svg'
    transition="1.5s"
    spinner
  >
    <template is="dom-if" if="{{showSelectionOrder}}">
      <div class="selection-order">
        [[selectionOrder]]
      </div>
    </template>

    <template is="dom-if" if="{{showProgress}}">
      <paper-progress
        value="[[progress]]"
      ></paper-progress>
    </template>

    <slot></slot>
  </mg-thumbnail>


  </template>
  <script>
    class MGItemImage extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'mg-item-image'; }

      static get properties() { return {
        /* If itemKey and key are set, edits will be synced. */
        itemKey: {
          type: String,
        },

        key: {
          type: String,
        },

        thumbnail: {
          type: String,
          value: '',
          observer: '_thumbnailChanged',
        },

        name: String,

        progress: Number,
        showProgress: {
          type: Boolean,
          computed: '_computeShowProgress(progress)',
        },

        selectionOrder: String,
        showSelectionOrder: {
          type: Boolean,
          computed: '_computeShowSelectionOrder(selectionOrder)',
        },


      }}

      static get observers() { return [
      ]}

      _thumbnailChanged(repKey) {
        if (repKey) {
          this.set('src',null);
          let uid = MGAPP.AU.currentUser.uid;
          MGAPP.registerRepresentation(repKey, (key,ev,val) => {
            ev === 'src' && repKey == this.thumbnail && this.set('src',val);
          });
        }
        else {
          this.set('src','images/logo-pumpkin-outline-grayout.svg');
        }
      }

      _computeShowProgress(progress) {
        if (typeof(progress) == "undefined") return false;
        if (progress == 100) return false;
        return true;
      }

      _computeShowSelectionOrder(selectionOrder) {
        if (selectionOrder) return true;
        return false;
      }

      _onEditImage(e) {
        console.log('edit',this);
        e.stopImmediatePropagation();
      }
    }

    customElements.define(MGItemImage.is, MGItemImage);
  </script>
</dom-module>
