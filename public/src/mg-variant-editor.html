<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="mg-common-styles.html">
<link rel="import" href="mg-variant-cell.html">
<link rel="import" href="mg-input.html">

<dom-module id="mg-variant-editor">
<template strip-whitespace>
    <custom-style>
  <style is="custom-style" include="paper-material-styles mg-common-styles iron-flex iron-flex-alignment">
  :host {
    /*border: 2px solid tomato;*/
    width: auto;
    height: auto;
    @apply --layout-horizontal;
    @apply --layout-start-justified;
    box-sizing: content-box;
  }

  #variant-selector {
    max-height: 20vh;
    overflow-y: auto;
  }

  #variants-container {
    padding: 5px;
    margin: 5px;
    border-radius: 5px;
  }

  #value-container {
    @apply --paper-font-caption;
    border-bottom: 1px dotted var(--booed-shadow-color);
  }

  #value-container iron-icon {
    --iron-icon-height: 14px;
  }

  </style>
    </custom-style>

    <div class="vertical layout">
  <div id="variants-container" class="paper-material vertical layout start-justified" elevation="1">

    <template is="dom-if" if="{{variant.value}}">
      <div id="value-container" class="horizontal layout center">
        [[variant.value]]
        <template is="dom-if" if="{{variant.variants}}">
          <iron-icon icon="chevron-right"></iron-icon>
          [[variant.type]]
        </template>
      </div>
    </template>
    <!-- Type Selector -->
      <template is="dom-if" if="{{variantsDataList.length}}">
    <div class="horizontal layout">
      <paper-dropdown-menu
        style="width:95px;margin-right:10px"
        label="ตัวเลือก"
      > <paper-listbox
          attr-for-selected="name"
          slot="dropdown-content"
          class="dropdown-content layout start"
          selected="{{selectedTypeDef.name}}"
        > <template is="dom-repeat" items="[[menu.entries]]">
            <paper-icon-item label="[[item.title]]" name="[[item.name]]">
              <iron-icon icon="[[item.icon]]" slot="item-icon"></iron-icon>
              [[item.title]]
            </paper-icon-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>

      <template is="dom-if" if="[[testEqual(selectedTypeDef.name,'custom')]]">

        <mg-input
          label="ชื่อ"
          value="{{selectedTypeDef.custom}}"
          min-width="70"
        > <iron-icon icon="editor:mode-edit" slot="prefix"></iron-icon>
        </mg-input>

      </template>
      <template is="dom-if" if="[[testEqual(selectedTypeDef.name,'price')]]">
        <paper-dropdown-menu
          style="width:95px"
          label="สกุลเงิน"
        > <paper-listbox
            slot="dropdown-content"
            class="dropdown-content"
            attr-for-selected="currency"
            selected="{{selectedTypeDef.custom}}"
          > <paper-icon-item label="บาท" currency="thb">
              <iron-icon icon="booed:attach-money-thb" slot="item-icon"></iron-icon> บาท
            </paper-icon-item>
            <paper-icon-item label="เยน" currency="jpy">
              <iron-icon icon="booed:attach-money-jpy" slot="item-icon"></iron-icon> เยน
            </paper-icon-item>
            <paper-icon-item label="วอน" currency="krw">
              <iron-icon icon="booed:attach-money-krw" slot="item-icon"></iron-icon> วอน
            </paper-icon-item>
            <paper-icon-item label="ยูเอสดอลล่าร์" currency="usd">
              <iron-icon icon="editor:attach-money" slot="item-icon"></iron-icon> ยูเอสดอลล่าร์
            </paper-icon-item>
          </paper-listbox>
        </paper-dropdown-menu>
      </template>
    </div>
      </template>

    <!-- Children List -->
    <iron-selector
      id="variant-selector"
      selected-attribute="selected"
      selected-item="{{selectedVariantCell}}"
      >
      <template is="dom-repeat" items="{{variantsDataList}}">
        <mg-variant-cell
          variant-type="[[_computeType(selectedTypeDef.name,selectedTypeDef.custom)]]"
          variant="{{item}}"
          >
        </mg-variant-cell>
      </template>
    </iron-selector>
    <template is="dom-if" if="{{_hasComment(variant.comment)}}">
      <mg-input
        label="คอมเม้นท์"
        value="{{variant.comment}}"
        min-width="150"
      > <iron-icon icon="editor:mode-edit" slot="prefix"></iron-icon>
      </mg-input>
    </template>

    <!-- Comment -->

    <!-- Foot Buttons -->
    <div class="horizontal layout center-justified">
      <paper-icon-button
        icon="add"
        on-click="_onAddVariant"
      ></paper-icon-button>

      <paper-icon-button
        icon="booed:duplicate-selection"
        on-click="_onDuplicateSelection"
        disabled="[[!selectedVariantCell]]"
      ></paper-icon-button>

        <template is="dom-if" if="{{!_hasComment(variant.comment)}}">
      <paper-icon-button
        icon="editor:mode-edit"
        on-click="_onAddComment"
      ></paper-icon-button>
        </template>

        <template is="dom-if" if="{{_hasComment(variant.comment)}}">
      <paper-icon-button
        icon="booed:comment-disabled"
        on-click="_onDeleteComment"
      ></paper-icon-button>
        </template>

      <paper-icon-button
        icon="backspace"
        on-click="_onBackspace"
      ></paper-icon-button>
    </div>

  </div>
    </div>

  <template is="dom-if" if="[[selectedSubvariant]]">
    <mg-variant-editor
      menu="[[menu]]"
      variant="{{selectedSubvariant}}"
      depth="[[_deeper(depth)]]"
    ></mg-variant-editor>
  </template>

</template>
<script>
class MGVariantsEditor extends Polymer.Element {
  static get is() { return 'mg-variant-editor'; }

  static get properties() { return {
    /* Map for caching index, uncomment this when __dataLinkedPaths can no longer be abused.
    variantsDataMap: {
      type: Object,
      value: function(){return new WeakMap()},
    },
    */

    variantsDataList: {
      type: Array,
      value: function(){return [];},
    },

    variant: {
      type: Object,
      notify: true,
      observer: '_variantChanged',
    },

    selectedTypeDef: {
      type: Object,
      value: function(){return {};},
    },
    menu: {
      type: Object,
      observer: '_menuChanged'
    },

    selectedSubvariant: {
      type: Object,
    },
    selectedVariantCell: {
      type: Object,
      value: null,
      observer: '_selectedVariantCellChanged',
    },

    /* debugging */
    depth: {
      value: 0,
    },
  }}

  _deeper(depth) {
    return depth + 1;
  }

  static get observers() { return [
    '_subvariantsChanged(selectedSubvariant.variants)',
    '_selectedTypeDefChanged(selectedTypeDef.name,selectedTypeDef.custom)',
    '_variantDataListChanged(variantsDataList.splices)',
    '_variantTypeChanged(variant.type)',
    '_variantsChanged(variant.variants)',
    '_variantsItemsChanged(variant.variants.*)',
  ]}

  _variantChanged(newVariant) {
    this.$['variant-selector'].select(null);
    this.splice('variantsDataList',0,this.variantsDataList.length);

    if (newVariant) {
      if (newVariant.variants) {
        for(let vkey in newVariant.variants){
          this.addVariantData(vkey, newVariant.variants[vkey]);
        }
      }
      if (newVariant.type) {
        let nc = newVariant.type.split(':');
        this.set('selectedTypeDef', {name:nc[0], custom:nc[1]});
      }
    }

    /*
      let nc = (newVariant.type||"custom:").split(':');
      this.set('selectedTypeDef',{name:nc[0], custom:nc[1]});
    */
  }

  _computeType(name,custom) {
    if (name == 'color' || name =='size') {
      custom = '';
    }
    return name + (custom ? ':'+custom : '');
  }

  _variantTypeChanged(newType,oldType) {
    if (newType) {
      let nc = newType.split(':');
      this.set('selectedTypeDef', {name:nc[0], custom:nc[1]});
    }
  }

  _selectedTypeDefChanged(name,custom) {
    if (name == 'custom') {
      this.set('variant.type','custom:'+(custom||''));
    } else if (name == 'price') {
      this.set('variant.type','price:'+(custom||''));
    } else if (name) {
      this.set('variant.type',name);
    }
  }

  _variantsItemsChanged(changes) {
    if (this.variant) {
      for (let key in this.variant.variants) {
        this.addVariantData(key, this.variant.variants[key]);
      }
    }
  }

  _variantsChanged(variants) {
    this.splice('variantsDataList',0,this.variantsDataList.length);
    for (let key in variants) {
      this.addVariantData(key, this.variant.variants[key]);
    }
  }


  _subvariantsChanged(variants) {
    if (variants) {
      this.selectedVariantCell.set('hasChildren', true);
    }
  }

  _hasComment(comment) {
    return typeof comment === 'string' ? true : false;
  }

  _onAddComment(e){
    this.set('variant.comment', '');
  }

  _onDeleteComment(e){
    this.set('variant.comment', null);
  }

  _onAddVariant(e){
    if (!this.variant) {
      this.set('variant',{type:'custom:'});
    }
    /* XXX should get key from a better path */
    let vkey = MHA.DB.ref().push().key;
    let variants = this.variant.variants;
    if (!variants) {
      this.set('variant.variants',{});
    }

    this.set(['variant.variants',vkey],{key$:vkey, type:'custom:'}); /* XXX custom: leaked into db even no use*/
    //this.addVariantData(this.variant.variants[vkey]);
    return vkey;
  }

  _variantDataListChanged(splices) {
    if (splices) {
      splices.indexSplices.forEach(s => {
        s.removed.forEach(v => {
          //this.variantsDataMap.delete(so);
          this.unlinkPaths('variant.variants.'+v.key$);
        });
        /* re-link all from the changed index */
        for(let i = s.index,so; so = s.object[i]; ++i) {
          //this.variantsDataMap.set(so,i);
          this.linkPaths('variant.variants.'+so.key$,'variantsDataList.'+i);
          if (so == this.selectedSubvariant) {
            this.linkPaths('variantsDataList.'+i,'selectedSubvariant');
          }
        }
      });
    }
  }

  /* An EXPERIMENT to rely on linked paths defined within __dataLinkedPaths.
   * This is going to use it instead of using indexOf() or observed selected index.
   * If one day this will broken it may then switch back to the variantsDataMap version.
   */
  _selectedVariantCellChanged(newElement,oldElement) {
    if (oldElement) {
      //this.unlinkPaths('variantsDataList.'+this.variantsDataMap.get(oldElement.variant));
      this.unlinkPaths(this.__dataLinkedPaths['variant.variants.'+oldElement.variant.key$]);
    }

    this.set('selectedSubvariant',null);
    if (newElement) {
      this.set('selectedSubvariant', newElement.variant);

      //this.linkPaths('variantsDataList.'+this.variantsDataMap.get(newElement.variant), 'selectedSubvariant');
      this.linkPaths(this.__dataLinkedPaths['variant.variants.'+newElement.variant.key$],'selectedSubvariant');
    }
  }

  addVariantData(key,variant) {
    if(!this.__dataLinkedPaths || !this.__dataLinkedPaths['variant.variants.'+key]) {
      variant.key$ = key;
      this.push('variantsDataList', variant);
    }
  }

  _onDuplicateSelection(e) {
    let vkey = this._onAddVariant(e);
  }

  testEqual(a,b) {
    if (a == b) return true;
    return false;
  }

  _menuChanged(newMenu,oldMenu) {
  }

}

customElements.define(MGVariantsEditor.is, MGVariantsEditor);
</script>
</dom-module>
