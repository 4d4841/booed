<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

/* XXX Make item behavior */
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="mg-common-styles.html">
<link rel="import" href="mg-input.html">


<dom-module id="mg-item">
  <template strip-whitespace>
      <custom-style>
    <style is="custom-style" include="mg-common-styles iron-flex iron-flex-alignment">
      :host {
      }

      paper-card {
        @apply(--layout-vertical);
        @apply(--layout-center);
        border-radius: 5px;
        padding: 0 20px;
        width: 300px;
      }

      .file-item {
        width: 100%;
        position: relative;
      }

      .photos-container {
        @apply(--layout-horizontal);
        padding: 0px;
        height: 100%;
      }

      .photo-thumbnail {
        display: block;
        width:200px;
        height:200px;
      }

      .photo {
        text-decoration: none;
        padding: 0;
        margin: 5px;
        border-radius: 5px;
        @apply(--layout-vertical);
        box-shadow: 1px 1px 2px var(--app-shadow-color);
        background-color: white;
        overflow: hidden;
        border: 2px solid white;
      }

    </style>
      </custom-style>

    <iron-collapse class="vertical layout" opened="[[_shouldOpen(itemId)]]">

      <div class="horizontal layout end">

          <dom-if if="[[loading]]">
        <template>
        <img height="62px" src="images/logo-bounce.svg">
        </template>
          </dom-if>

          <dom-if if="[[!loading]]">
        <template>

          <paper-input
            label="ชื่อแกลเลอรี่"
            focused="{{focusedName}}"
            always-float-label="[[focusedName]]"
            value="{{itemName}}"
          >
            <iron-icon icon="[[_iconForRole(itemRole)]]" slot="prefix"></iron-icon>
          </paper-input>

<!--
            <dom-repeat items="[[photoList]]">
          <template>
            <div class="file-item">
              <paper-progress style="pointer-events:none;position:absolute;bottom:5px" value="40"></paper-progress>
              <div class="horizontal layout center">
                <paper-icon-button icon="close" on-tap="_onDeletePhoto">
                </paper-icon-button>
                <div class="flex">aname</div>
                <div>[[_formatSize(100)]]</div>
              </div>
            </div>
          </template>
            </dom-repeat>
-->

          <paper-button on-tap="_onAddButtonTap">
            <iron-icon icon="add-to-photos"></iron-icon> เพิ่มรูป
          </paper-button>

        </template>
          </dom-if>

        <input type="file" id="fileInput" on-change="_filesSelected" hidden multiple>

      </div>

      <iron-selector class="photos-container horizontal layout wrap" attr-for-selected="name">
        <dom-repeat items="[[photoList]]" mutable-data>
      <template>
      <paper-button name="[[item.key]]" class="photo" on-click="_onThumbClick">
        <iron-image class="photo-thumbnail" src="[[item.url]]" sizing="contain"></iron-image>
        <paper-progress
          style="width:180px; pointer-events:none;position:absolute;bottom:5px"
          value="[[item.progress]]"
          hidden="[[_hideProgress(item.progress)]]"
        ></paper-progress>
      </paper-button>
      </template>
        </dom-repeat>
      </iron-selector>

    </iron-collapse>

  </template>
  <script>
    class MGItem extends Polymer.Element {
      static get is() { return 'mg-item'; }

      static get properties() { return {
        files: Object,

        itemId: {
          type: String,
          notify: true,
        },

        itemRole: {
          type: String,
        },

        itemName: {
          type: String,
          notify: true,
        },

        images: {
          type: Object,
          value: {},
        },

        photoList: {
          type: Array,
          value: [],
        },

        previousItems: {
          type: Object,
          value: {},
        },

      }}

      static get observers() { return [
        '_itemIdChanged(me.user, itemId)',
        '_itemNameChanged(me.user, itemRole, itemName)',
        '_imagesChanged(images.*)',
      ]}

      _imagesChanged(imgChanges) {
        if (imgChanges.path.startsWith("images.")) {
          for (let i = 0, photo; photo = this.photoList[i]; ++i) {
            if (imgChanges.path == "images."+photo.key) {
              for (let key in imgChanges.value) {
                this.set('photoList.'+i+'.'+key, imgChanges.value[key]);
              }
              return;
            }
            if (imgChanges.path == "images."+photo.key+".progress") {
                let percent = Math.floor(imgChanges.value);
                this.set('photoList.'+i+'.progress', percent);
                return;
            }
          }
          if (imgChanges.value.key && imgChanges.path == "images."+imgChanges.value.key) {
            console.log("push?",imgChanges.path, imgChanges.value);
            this.push('photoList', imgChanges.value);
          }
        } else if (imgChanges.path == "images") {
          this.set('photoList', []);
          for (let key in imgChanges.value) {
            this.push('photoList', imgChanges.value[key]);
          }
        }
      }

      _filesSelected(e) {
        let files = e.target.files;

        if (files && files.length) {

          let itemId = this.itemId;
          let uid = this.me.user.uid;
          let role = this.itemRole;
          let storage = MGFIRE.storage();
          let database = MGFIRE.database();
          let imagesRef = database.ref('items').child(itemId).child('images');

          for (let i = 0,imgFile; imgFile = files[i]; ++i) {
            let imgKey = imagesRef.push().key;
            let imgRef = storage.ref('home').child(uid)
            .child('items').child(itemId).child(imgKey);

            let imgData = {url: "/images/logo-bounce.svg", key:imgKey, name:imgFile.name};

//            this.push('photoList',imgData);
            this.set('appImages.'+imgKey, imgData);
            this.set('images.'+imgKey, imgData);

            /* upload image onto storage */
            imgRef.put(imgFile).on(firebase.storage.TaskEvent.STATE_CHANGED, function(snapshot){
              let percent = snapshot.bytesTransferred / snapshot.totalBytes * 100;
              if (this.itemId == itemId) {
//                this.set('images.'+imgKey, {url: "/images/logo-bounce.svg", key:imgKey, name:imgFile.name, progress:percent});
                this.set('images.'+imgKey+'.progress', percent);
              }
              else {
                this.set('appImages.'+imgKey+'.progress', percent);
              }
            }.bind(this), function(error){
              console.error("ERR",error);
            }, function() {
              /* image uploaded, register file id into the database */
              var registerData = {};

              registerData["items/"+itemId+"/images/"+imgKey] = {name:imgFile.name};
              registerData["items/"+itemId+"/role"] = this.itemRole;
              registerData["home/"+uid+"/items/"+itemId+"/time"] = firebase.database.ServerValue.TIMESTAMP;

              MGFIRE.database().ref().update(registerData, function(error){
                if (!error) {
                  imgRef.getDownloadURL().then(function(url){
                    let imgData = {url:url, key:imgKey, name:imgFile.name};
                    this.set('appImages.'+imgKey, Object.assign(this.appImages.imgKey||{},imgData));

                    if (itemId == this.itemId) {
                      this.set('images.'+imgKey, imgData);
                    }
                  }.bind(this));
                } else {
                  console.error("ERR",error);
                }
              }.bind(this));
            }.bind(this));
          }
        }
      }

      _hideProgress(progress) {
        if (!progress || progress == 100) return true;
        return false;
      }

      _getItemSnapshot(snapshot) {
        this.set('loading', false);
        let itemId = this.itemId;
        let v = snapshot.val();

        if (snapshot.key != itemId) {
          return;
        }

        if (v) {
          this.set('itemRole',v.role);
          this.set('itemName',this._ItemName = v.name);
          if (v.images) {
            let itemRef = MGFIRE.storage().ref('home').child(this.me.user.uid).child('items').child(snapshot.key);
            for (let key in v.images) {
              let imgData = this.appImages[key];

              this.set('images.'+key, imgData || {url: "/images/logo-bounce.svg", key:key});
              /* data with URL exists */
              if (imgData && imgData.url) {
                continue;
              }
              itemRef.child(key).getDownloadURL().then(function(url){
                let imgData = {url:url, key:key, name:v.images[key].name};
                this.set('appImages.'+key, Object.assign(this.appImages.key||{},imgData))
                if (itemId == this.itemId) {
                  this.set('images.'+key, imgData);
                }
              }.bind(this));
            }
          }
        }
      }

      _getDataError(error) {
        console.error("ERR", error);
      }

      _itemIdChanged(user, itemId) {
        if (!user || !itemId) {
          return;
        }

        this.previousItems[itemId] = this.previousItems[itemId] || {};

        this._ItemName = "ไอเท็มไม่มีชื่อ";
        this.set('itemName',this._ItemName);
        this.set('photoList',[]);
        this.set('images', this.previousItems[itemId]);
        this.set('loading', true);
        let database = MGFIRE.database();
        database.ref('items').child(itemId).once('value', this._getItemSnapshot, this._getDataError, this);
      }

      _itemNameChanged(user, itemRole, itemName) {
        if (!user || !itemRole || (itemName == this._ItemName)) {
          return;
        }

        if (itemName) {

          delete this._ItemName;
          var registerData = {};
          registerData["items/"+this.itemId+"/name"] = itemName;
          registerData["items/"+this.itemId+"/role"] = this.itemRole;
          registerData["home/"+this.me.user.uid+"/items/"+this.itemId+"/time"] = firebase.database.ServerValue.TIMESTAMP;

          MGFIRE.database().ref().update(registerData, function(error){
            if (error) {
              console.error("ERR",error);
            }
          }.bind(this));
        }
      }

      _formatSize(bytes) {
        const base = 1024;
        const unit = ~~(Math.log(bytes) / Math.log(base));
        const dec = Math.max(0, Math.min(3, unit - 1));
        const size = parseFloat((bytes / Math.pow(base, unit)).toFixed(dec));
        return size + ' ' + ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'][unit];
      }

      _iconForRole(role) {
        switch(role) {
          case "product": return "local-mall";
          case "article": return "local-library";
          case "collection": return "group-work";
          case "gallery": return "photo-library";
          default: return "help";
        }
      }

      _onAddButtonTap(e) {
        this.$.fileInput.value = '';
        this.$.fileInput.click();
      }

      _onDeletePhoto(e) {
        console.log("e",e.model.index);
      }

      _shouldOpen(id) {
        if (id) return true;
        return false;
      }

      newItem(role,name) {
        let key = MGFIRE.database().ref('items').push().key;
        this.set("itemId", key);
        this.set('itemRole', role);
         /* Only update UI name without server registration */
        this.set('itemName', this._ItemName = name || "แกลเลอรี่ไม่มีชื่อ");
      }

    }

    customElements.define(MGItem.is, MGItem);
  </script>
</dom-module>
