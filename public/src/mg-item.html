<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

/* XXX Make item behavior */
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="mg-common-styles.html">
<link rel="import" href="mg-input.html">


<dom-module id="mg-item">
  <template strip-whitespace>
      <custom-style>
    <style is="custom-style" include="mg-common-styles iron-flex iron-flex-alignment">
      :host {
      }

      paper-card {
        @apply(--layout-vertical);
        @apply(--layout-center);
        border-radius: 5px;
        padding: 0 20px;
        width: 300px;
      }

      .file-item {
        width: 100%;
        position: relative;
      }

      .photos-container {
        @apply(--layout-horizontal);
        padding: 0px;
        height: 100%;
      }

      .photo-thumbnail {
        display: block;
        width:200px;
        height:200px;
      }

      .photo {
        text-decoration: none;
        padding: 0;
        margin: 5px;
        border-radius: 5px;
        @apply(--layout-vertical);
        box-shadow: 1px 1px 2px var(--app-shadow-color);
        background-color: white;
        overflow: hidden;
        border: 2px solid white;
      }

    </style>
      </custom-style>

    <iron-collapse class="vertical layout" opened="[[_shouldOpen(itemId)]]">

      <div class="horizontal layout end">

          <dom-if if="[[loading]]">
        <template>
        <img height="62px" src="images/logo-bounce.svg">
        </template>
          </dom-if>

          <dom-if if="[[!loading]]">
        <template>

          <paper-input
            label="ชื่อแกลเลอรี่"
            focused="{{focusedName}}"
            always-float-label="[[focusedName]]"
            value="{{itemName}}"
          >
            <iron-icon icon="[[_iconForRole(_ItemRole)]]" slot="prefix"></iron-icon>
          </paper-input>

<!--
            <dom-repeat items="[[photoList]]">
          <template>
            <div class="file-item">
              <paper-progress style="pointer-events:none;position:absolute;bottom:5px" value="40"></paper-progress>
              <div class="horizontal layout center">
                <paper-icon-button icon="close" on-tap="_onDeletePhoto">
                </paper-icon-button>
                <div class="flex">aname</div>
                <div>[[_formatSize(100)]]</div>
              </div>
            </div>
          </template>
            </dom-repeat>
-->

          <paper-button on-tap="_onAddButtonTap">
            <iron-icon icon="add-to-photos"></iron-icon> เพิ่มรูป
          </paper-button>

        </template>
          </dom-if>

        <input type="file" id="fileInput" on-change="_filesSelected" hidden multiple>

      </div>

      <iron-selector class="photos-container horizontal layout wrap" attr-for-selected="name">
        <dom-repeat items="[[photoList]]" mutable-data>
      <template>
      <paper-button name="[[item.key]]" class="photo" on-click="_onThumbClick">
        <iron-image class="photo-thumbnail" src="[[item.url]]" sizing="contain"></iron-image>
      </paper-button>
      </template>
        </dom-repeat>
      </iron-selector>

    </iron-collapse>

  </template>
  <script>
    class MGItem extends Polymer.Element {
      static get is() { return 'mg-item'; }

      static get properties() { return {
        files: Object,

        itemId: {
          type: String,
          observer: "_itemIdChanged",
          notify: true,
        },

        itemName: {
          type: String,
          observer: "_itemNameChanged",
          notify: true,
        },

        items: {
          type: Object,
          notify: true,
        },

        photoList: {
          type: Array,
          value: [],
        },

      }}

      static get observers() { return [
      ]}

      _computePhotoList(items) {
        let ret = [];
        return ret;
        Object.values(this.items[this.itemId]).forEach(function(item){
//          ret.push('a');
        },this);
        return ret;
      }

      _filesSelected(e) {
        if (!this.itemId) {
          console.error("ERR WHY");
          return;
        }

        let itemId = this.itemId;
        let files = e.target.files;
        let uid = this.me.user.uid;

        if (files && files.length) {
          let storage = MGFIRE.storage();
          let database = MGFIRE.database();
          let imagesRef = database.ref('items').child(itemId).child('images');
          for (let i = 0,img; img = files[i]; ++i) {
            let imgKey = imagesRef.push().key;
            let imgRef = storage.ref('home').child(uid)
            .child('items').child(itemId).child(imgKey);

            imgRef.put(img).on('state_changed', function(snapshot){

            }.bind(this), function(error){
              console.error("ERR",error);
            }.bind(this), function(){
              var registerData = {};

              registerData["items/"+itemId+"/images/"+imgKey] = {name:img.name};
              registerData["items/"+itemId+"/role"] = this._ItemRole;
              registerData["home/"+uid+"/items/"+itemId+"/time"] = firebase.database.ServerValue.TIMESTAMP;

              MGFIRE.database().ref().update(registerData, function(error){
                if (!error) {
                  imgRef.getDownloadURL().then(function(url){
                    Object.assign(this.items, {[itemId]:{images:{[imgKey]:{url:url}}}});
                  }.bind(this));
                } else {
                  console.error("ERR",error);
                }
              }.bind(this));
            }.bind(this));
          }
        }
      }

      _formatSize(bytes) {
        const base = 1024;
        const unit = ~~(Math.log(bytes) / Math.log(base));
        const dec = Math.max(0, Math.min(3, unit - 1));
        const size = parseFloat((bytes / Math.pow(base, unit)).toFixed(dec));
        return size + ' ' + ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'][unit];
      }

      _iconForRole(role) {
        switch(role) {
          case "product": return "local-mall";
          case "article": return "local-library";
          case "collection": return "group-work";
          case "gallery": return "photo-library";
          default: return "help";
        }
      }

      _onAddButtonTap(e) {
        this.$.fileInput.value = '';
        this.$.fileInput.click();
      }

      _onDeletePhoto(e) {
        console.log("e",e.model.index);
      }

      _shouldOpen(id) {
        if (id) return true;
        return false;
      }

      _itemIdChanged(itemId) {
        if (itemId) {
          this.set('loading', true);
          this.set('photoList',[]);
          let database = MGFIRE.database();
          database.ref('items').child(itemId).once('value', this._getItemSnapshot, this._getDataError, this);
        }
      }

      _getItemSnapshot(snapshot) {
        this.set('loading', false);
        let v = snapshot.val();

        if (this._ItemRole == "gallery") {
          this.items[snapshot.key] = {role: "gallery", name: this.itemName, images: {}};
          Object.assign(this.items, {[snapshot.key]:{role:"gallery", name:this.itemName}});
        } else {
          this.items[snapshot.key] = {role: this._ItemRole, name: this.itemName};
          Object.assign(this.items, {[snapshot.key]:{role:this._ItemRole, name:this.itemName}});
        }

        if (v) {
          this.set('_ItemRole',v.role);
          let itemId = this.itemId;
          if (v.images) {
            let itemRef = MGFIRE.storage().ref('home').child(this.me.user.uid).child('items').child(snapshot.key);
            for (let key in v.images) {
              itemRef.child(key).getDownloadURL().then(function(url){
                if (itemId == this.itemId) {
                  this.push('photoList', {url:url, key:key, data:v.images[key]});
                }

                Object.assign(this.items, {[snapshot.key]:{images:{[key]:{url:url, data:v.images[key]}}}});
              }.bind(this));
            }
            this.items[snapshot.key].role = v.role;
          }

          if (v.name) {
            this.items[snapshot.key].name = v.name;
          }

          if (snapshot.key == this.itemId) {
            this._ItemName = this.items[snapshot.key].name;
            this.set('itemName', this._ItemName);
          }
        }
      }

      _getDataError(error) {
        console.error("ERR", error);
      }

      _itemNameChanged(itemName) {
        if (!itemName) {
          delete this._ItemName;
          itemName = "แกลเลอรี่ไม่มีชื่อ";
        }

        if (itemName && itemName != this._ItemName) {

          delete this._ItemName;
          var registerData = {};
          registerData["items/"+this.itemId+"/name"] = itemName;
          registerData["items/"+this.itemId+"/role"] = this.items[this.itemId].role || this._ItemRole;
          registerData["home/"+this.me.user.uid+"/items/"+this.itemId+"/time"] = firebase.database.ServerValue.TIMESTAMP;

          MGFIRE.database().ref().update(registerData, function(error){
            if (error) {
              console.error("ERR",error);
            }
          }.bind(this));
        }
      }

      newItem(role,name) {
        let key = MGFIRE.database().ref('items').push().key;
        this.set('_ItemRole', role);
        this._ItemName = name || "แกลเลอรี่ไม่มีชื่อ";
        this.set('itemName', this._ItemName); /* Only update UI name without server registration */
        this.set("itemId", key);
      }

    }

    customElements.define(MGItem.is, MGItem);
  </script>
</dom-module>
