<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

/* XXX Make item behavior */
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="mg-common-styles.html">
<link rel="import" href="mg-input.html">
<link rel="import" href="mg-item-image.html">


<dom-module id="mg-item">
  <template strip-whitespace>
      <custom-style>
    <style is="custom-style" include="mg-common-styles iron-flex iron-flex-alignment">
      :host {
      }

      .file-item {
        width: 100%;
        position: relative;
      }

      #selector {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        padding: 0px;
        height: 100%;
      }

      .image-icon {
        margin: 0 5px 5px 0;
        width: 120px;
        height: 120px;
      }

    </style>
      </custom-style>

    <iron-collapse class="vertical layout" opened="[[_shouldOpen(itemId)]]">

      <div class="horizontal layout end">

        <template is="dom-if" if="{{loading}}">
          <img height="62px" src="images/logo-bounce.svg">
        </template>

        <template is="dom-if" if="{{!loading}}">

          <paper-input
            label="ชื่อแกลเลอรี่"
            focused="{{focusedName}}"
            always-float-label="[[focusedName]]"
            value="{{itemName}}"
          >
            <iron-icon icon="[[_iconForRole(itemRole)]]" slot="prefix"></iron-icon>
          </paper-input>

          <paper-button on-tap="_onAddButtonTap">
            <iron-icon icon="add"></iron-icon> เพิ่มรูป
          </paper-button>
          <template is="dom-if" if="{{hasSelection}}">
            <paper-button on-tap="_onAddButtonTap">
              <iron-icon icon="delete"></iron-icon> ลบ
            </paper-button>
            <paper-button on-tap="_onAddButtonTap">
              <iron-icon icon="reorder"></iron-icon> เรียง
            </paper-button>
          <paper-button on-tap="_onAddButtonTap">
            <iron-icon icon="add-to-photos"></iron-icon> แกลเลอรี่
          </paper-button>
          </template>

        </template>

        <input type="file" id="fileInput" on-change="_filesSelected" hidden multiple>

      </div>

      <iron-selector
        id="selector"
        attr-for-selected="key"
        selected-values="{{selectedImages}}"
        multi>

      <template is="dom-repeat" items="{{photoList}}" mutable-data>

        <mg-item-image
          key="[[item.key]]"
          class="image-icon"
          src="[[item.src]]"
          progress="[[item.progress]]"
          label="[[item.name]]"
          selection-order="[[item.selectionOrder]]"
          icon="photo"
          transition="1.5s"
          spinner
          on-tap="_onItemTap"
        ></mg-item-image>

      </template>

      </iron-selector>

    </iron-collapse>

  </template>
  <script>
    class MGItem extends Polymer.Element {
      static get is() { return 'mg-item'; }

      static get properties() { return {
        files: Object,

        itemId: {
          type: String,
          notify: true,
        },

        itemRole: {
          type: String,
        },

        itemName: {
          type: String,
          notify: true,
        },

        photoList: {
          type: Array,
          value: [],
        },

        selectedImages: {
          type: Array,
          notify: true,
        },

        hasSelection: Boolean,
      }}

      static get observers() { return [
        '_itemIdChanged(me.user, itemId)',
        '_itemNameChanged(me.user, itemRole, itemName)',
        '_selectedImagesChanged(selectedImages.splices)',
      ]}

      _selectedImagesChanged(changes) {
        if (changes) {
          let orderNumber = 0;
          changes.indexSplices.forEach(function(splice){
            splice.removed.forEach(function(removedKey){
              for(let i = 0, photo; photo = this.photoList[i]; ++i ) {
                if (photo.key == removedKey) {
                  this.photoList[i].selectionOrder = null;
                  this.notifyPath('photoList.'+i+'.selectionOrder');
                }
              }
            }.bind(this))
          }.bind(this));

          this.selectedImages.forEach(function(key){
            for(let i = 0, photo; photo = this.photoList[i]; ++i ) {
              if (photo.key == key) {
                this.photoList[i].selectionOrder = ++orderNumber;
                this.notifyPath('photoList.'+i+'.selectionOrder');
              }
            }
          }.bind(this));
        }
        if (this.selectedImages.length) {
          this.set('hasSelection', true);
        } else {
          this.set('hasSelection', false);
        }

        /*
        if (this._InsertRange) {
          delete this._InsertRange;
          let beginKey = this.selectedImages.length ?
          let beginIndex,endIndex;
          for(let i = 0, photo; photo = this.photoList[i]; ++i) {
            if ()
          }
        }
        */
      }

      _onItemTap(e) {
        if (e.detail.sourceEvent.shiftKey) {
          if (typeof(this._LastTapIndex) == "undefined") {
            this._LastTapIndex = -1;
          }

          let inc = this._LastTapIndex < e.model.index ? 1 : -1;

          for (let i = this._LastTapIndex + inc; inc > 0 ? i < e.model.index : i > e.model.index; i+=inc) {
            this.$.selector.selectIndex(i);
          }
        }
        this._LastTapIndex = e.model.index;
      }

      _indexId(imageId) {
        let appData = this.appImages[imageId];
        if (!appData) {
          return -1;
        }

        for (let i = 0, data; data = this.photoList[i]; ++i) {
          if (data === appData) {
            return i;
          }
        }

        return -1;
      }

      _filesSelected(e) {
        let files = e.target.files;

        if (!files || !files.length) {
          return;
        }

        let itemId = this.itemId;
        let uid = this.me.user.uid;
        let role = this.itemRole;
        console.assert(role, "Role is missing");
        let storage = MGFIRE.storage();
        let database = MGFIRE.database();
        let imagesRef = database.ref('items').child(itemId).child('images');
        ///XXX this should be array to maintain order

        Array.from(files).forEach(function(imgFile){
          let imgKey = imagesRef.push().key;
          let imgRef = storage.ref('home')
                              .child(uid)
                              .child('images')
                              .child(imgKey);

          let imgData = {key:imgKey, name:imgFile.name};
          let lastIndex = this.push('photoList',imgData) - 1;

          this.set('appImages.'+imgKey, imgData);

          var reader = new FileReader();
          reader.onload = function(e) {

            this.set('appImages.'+imgKey+'.src', e.target.result);
            let idx = this._indexId(imgKey);
            if (idx > -1) { this.notifyPath('photoList.'+idx+'.src'); }

          }.bind(this);
          reader.readAsDataURL(imgFile);

          imgRef.put(imgFile).on(firebase.storage.TaskEvent.STATE_CHANGED, function(snapshot){

            this.set('appImages.'+imgKey+'.progress', (snapshot.bytesTransferred / snapshot.totalBytes * 100).toFixed(2));
            let idx = this._indexId(imgKey);
            if (idx > -1) { this.notifyPath('photoList.'+idx+'.progress'); }

          }.bind(this), function(error){
            console.error("ERR",error);
          }, function() {
            /* image uploaded, register file id into the database */
            var registerData = {};

            registerData['items/'+itemId+'/images/'+imgKey] = {name:imgFile.name};
            registerData['items/'+itemId+'/uid'] = uid;
            registerData['items/'+itemId+'/role'] = role;
            registerData['home/'+uid+'/items/'+itemId+'/time'] = firebase.database.ServerValue.TIMESTAMP;

            MGFIRE.database().ref().update(registerData, function(error){
              if (!error) {
                /*
                imgRef.getDownloadURL().then(function(url){

                  this.set('appImages.'+imgKey+'.src', url);
                  let idx = this._indexId(imgKey);
                  if (idx > -1) { this.notifyPath('photoList.'+idx+'.src'); }

                }.bind(this));
                */
              } else {
                console.error("ERR",error);
              }
            }.bind(this));
          }.bind(this));
        },this);
      }

      _getItemSnapshot(snapshot) {
        let itemId = this.itemId;
        let v = snapshot.val();
        this.set('loading', false);

        /* XXX role must already be set in the database */
        if (v && v.role) {
          if (snapshot.key == itemId) {
            this.set('itemRole',v.role);
            this.set('itemName',this._ItemName = v.name);
          }

          if (v.images) {
            let itemRef = MGFIRE.storage().ref('home')
                                          .child(this.me.user.uid)
                                          .child('images');

            Object.keys(v.images).forEach(function(imgKey){
              let imgData = this.appImages[imgKey];
              let idx = this._indexId(imgKey);

              if (!imgData) {
                imgData = {key:imgKey, name:v.images[imgKey].name};
                this.set('appImages.'+imgKey,imgData);
              } else {
                if (v.images[imgKey].name) {
                  this.set('appImages.'+imgKey+'.name', v.images[imgKey].name);
                  if (idx > -1) { this.notifyPath('photoList.'+idx+'.name'); }
                }
              }

              if (snapshot.key == itemId) {
                if (idx < 0) {
                  delete imgData.selectionOrder;
                  this.push('photoList',imgData);
                }
              }

              if (!imgData.src) {
                itemRef.child(imgKey).getDownloadURL().then(function(url){

                  this.set('appImages.'+imgKey+'.src', url);
                  let idx = this._indexId(imgKey);
                  if (idx > -1) { this.notifyPath('photoList.'+idx+'.src'); }

                }.bind(this));
              }
            }, this);

          }
        } else if (!this.itemRole){
          /* No data and the role isn't set then the path should be reset back */
          this.set('itemId', null);
        }/* else {
          console.log("new item");
        }*/
      }

      _getDataError(error) {
        console.error("ERR", error);
        this._ItemReference.off('value', this._getItemSnapshot, this);
        delete this._ItemReference;
      }

      _itemIdChanged(user, itemId) {
        delete this._LastTapIndex;
        if (this._ItemReference) {
          this._ItemReference.off('value', this._getItemSnapshot, this);
          delete this._ItemReference;
        }

        if (!user || !itemId) {
          return;
        }

//        this.previousItems[itemId] = this.previousItems[itemId] || {};

        this._ItemName = "ไอเท็มไม่มีชื่อ";
        this.set('itemName',this._ItemName);
        this.set('selectedImages',[]);
        this.set('photoList',[]);
        this.set('loading', true);
        this._ItemReference = MGFIRE.database().ref('items').child(itemId);
        this._ItemReference.on('value', this._getItemSnapshot, this._getDataError, this);
      }

      _itemNameChanged(user, itemRole, itemName) {
        if (!user || !itemRole || (itemName == this._ItemName)) {
          return;
        }

        if (itemName) {

          delete this._ItemName;
          var registerData = {};
          registerData['items/'+this.itemId+'/uid'] = user.uid;
          registerData['items/'+this.itemId+'/name'] = itemName;
          registerData['items/'+this.itemId+'/role'] = this.itemRole;
          registerData['home/'+user.uid+'/items/'+this.itemId+'/time'] = firebase.database.ServerValue.TIMESTAMP;

          MGFIRE.database().ref().update(registerData, function(error){
            if (error) {
              console.error("ERR",error);
            }
          });
        }
      }

      _formatSize(bytes) {
        const base = 1024;
        const unit = ~~(Math.log(bytes) / Math.log(base));
        const dec = Math.max(0, Math.min(3, unit - 1));
        const size = parseFloat((bytes / Math.pow(base, unit)).toFixed(dec));
        return size + ' ' + ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'][unit];
      }

      _iconForRole(role) {
        return MGIconForRole(role);
      }

      _onAddButtonTap(e) {
        this.$.fileInput.value = '';
        this.$.fileInput.click();
      }

      _onDeletePhoto(e) {
        console.log("e",e.model.index);
      }

      _shouldOpen(id) {
        if (id) return true;
        return false;
      }

      newItem(role,name) {
        let key = MGFIRE.database().ref('items').push().key;
        this.set('itemId', key);
        this.set('itemRole', role);
         /* Only update UI name without server registration */
        this.set('itemName', this._ItemName = name || "แกลเลอรี่ไม่มีชื่อ");
      }

    }

    customElements.define(MGItem.is, MGItem);
  </script>
</dom-module>
