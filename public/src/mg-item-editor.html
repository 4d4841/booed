<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">

<dom-module id="mg-item-editor">
  <template strip-whitespace>

    <template is="dom-if" if="{{loading}}">
      <img height="62px" src="images/logo-bounce.svg">
    </template>

    <template is="dom-if" if="{{!loading}}">
      <paper-input
        label="ชื่อแกลเลอรี่"
        focused="{{focusedName}}"
        always-float-label="[[focusedName]]"
        value="{{itemName}}"
      >
        <iron-icon icon="[[_iconForRole(itemRole)]]" slot="prefix"></iron-icon>
      </paper-input>

    </template>

  </template>
  <script>
    class MGItemEditor extends Polymer.Element {
      static get is() { return 'mg-item-editor'; }

      static get properties() { return {
        itemKey: {
          type: String,
          notify: true,
        },

        itemRole: {
          type: String,
        },

        itemName: {
          type: String,
          notify: true,
        },

        loading: {
          type: Boolean,
          notify: true,
        },

        clipboardList: {
          type: Array,
          notify: true,
        },

        pastedData: {
          type: Array,
          observer: '_pastedDataChanged',
        },

        editing: {
          type: Boolean,
          notify: true,
        },

      }}

      static get observers() { return [
        '_itemKeyChanged(me.user, itemKey)',
        '_itemNameChanged(me.user, itemRole, itemName)',
      ]}

      setItem(path,value) {
        console.error("Subclass must override this.");
      }

      onItemSnapshot(snapshot) {
        console.error("Subclass must override this.");
      }

      _pastedDataChanged(paste) {
        console.error("Subclass must override this.");
      }

      onDataError(error) {
        console.error("ERR", error);
        this._ItemReference.off('value', this.onItemSnapshot, this);
        delete this._ItemReference;
      }

      _itemKeyChanged(user, itemKey) {

        if (this._ItemReference) {
          this._ItemReference.off('value', this.onItemSnapshot, this);
          delete this._ItemReference;
        }

        if (!user || !itemKey) {
          return;
        }

        this._ItemName = "ไอเท็มไม่มีชื่อ";
        this.set('itemName',this._ItemName);

        this.set('loading', true);

        this._ItemReference = MHA.DB.ref('home').child(MHA.AU.currentUser.uid)
                                    .child('items').child(itemKey);
        this._ItemReference.on('value', this.onItemSnapshot, this.onDataError, this);
      }

      _itemNameChanged(user, itemRole, itemName) {
        if (!user || !itemRole || (itemName == this._ItemName)) {
          return;
        }

        if (itemName || itemName === "") {

          delete this._ItemName;
          var registerData = {
            ['items/'+this.itemKey+'/uid']: user.uid,
            ['items/'+this.itemKey+'/name']: itemName,
            ['items/'+this.itemKey+'/role']: this.itemRole,
            ['home/'+user.uid+'/items/'+this.itemKey+'/name']: itemName,
            ['home/'+user.uid+'/items/'+this.itemKey+'/role']: itemRole,
            ['home/'+user.uid+'/items/'+this.itemKey+'/time']: firebase.database.ServerValue.TIMESTAMP,
          };

          MHA.DB.ref().update(registerData, function(error){
            if (error) {
              console.error("ERR",error);
            }
          });
        }
      }

      _iconForRole(role) {
        switch(role) {
          case "product": return "local-mall";
          case "article": return "local-library";
          case "collection": return "group-work";
          case "gallery": return "photo-library";
          case "photo": return "photo";
          case "sales": return "sales-baht";
          default: return role;
        }
      }

      newItem(role,name) {
        let key = MHA.DB.ref('items').push().key;
        this.set('itemRole', role);
        this.set('itemKey', key);
         /* Only update UI name without server registration */
        this.set('itemName', this._ItemName = name || "แกลเลอรี่ไม่มีชื่อ");
      }
    }

    customElements.define(MGItemEditor.is, MGItemEditor);
  </script>
</dom-module>
