<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="mg-data.html">
<link rel="import" href="mg-input.html">
<link rel="import" href="mg-clipboard-view.html">

    <dom-module id="mg-item-editor">
  <template strip-whitespace>
<style>

:host {
  display: block;
  background-size: 60%;
  background-position: center;
  @apply --layout-vertical;
  @apply --layout-flex;
  border-radius: 5px;
}

:host([empty]){
  display: none;
}

#name-editor {
  margin-left: 8px;
  margin-right: 20px;
}

@media (max-width: 767px) {
}

</style>

<mg-data
  items="{{items}}"
  configurations="{{configurations}}"
></mg-data>


  <div class="horizontal layout">
<mg-input
  id="name-editor"
  label="[[_formatLabelDescription(itemRole)]]"
  icon="[[iconForRole(itemRole)]]"
  focused="{{focusedName}}"
  value="{{itemName}}"
></mg-input>
  </div>

  </template>
  <script>
var MGItemEditor
(function() {

MGItemEditor = class __MGItemEditor extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element) {

  static get is() { return 'mg-item-editor'; }

  static get properties() { return {
    configurations: Object,
    language: String,
    resources: { value: MHA.translations, },

    empty: {
      type: Boolean,
      notify: true,
      reflectToAttribute: true,
    },

    itemKey: {
      type: String,
      notify: true,
      value: null,
      observer: '_itemKeyChanged',
    },

    itemRole: {
      type: String,
    },

    itemName: {
      type: String,
      notify: true,
    },

    clipboardList: {
      type: Array,
      notify: true,
    },

    editing: {
      type: Boolean,
      notify: true,
    },

    me: Object,
  }}

  static get observers() { return [
    '_itemsChanged(items.*)',
    '_itemNameChanged(me.user, itemRole, itemName)',
    '_languageChanged(configurations.language)',
  ]}

  updateChanges(path,value) {
    console.error("Subclass must override this.");
  }

  /*
  onItemSnapshot(snapshot) {
    console.error("Subclass must override this.");
  }
  */

  _pastedDataChanged(paste) {
    console.error("Subclass must override this.");
  }

  /*
  onDataError(error) {
    console.error("ERR", error);
    this._ItemReference.off('value', this.onItemSnapshot, this);
    delete this._ItemReference;
  }
  */

  _itemKeyChanged(itemKey) {
    this.set('empty',itemKey ? false : true);
    this.set('itemName', null);
  }

  _itemsChanged(change) {
    if (!this.itemKey || !change.path.startsWith('items.'+this.itemKey)) return;
    /* 27 = itemKey.length + 'items.'.length + '.' */
    this.updateChanges(change.path.slice(27).split('.'), change.value);
  }

  _itemNameChanged(user, itemRole, itemName) {

    if (!user || !itemRole || (!this.focusedName)) {
      return;
    }

    if (itemName || itemName === "") {
      var registerData = {
        ['items/'+this.itemKey+'/uid']: user.uid,
        ['items/'+this.itemKey+'/name']: itemName,
        ['items/'+this.itemKey+'/role']: this.itemRole,
        ['home/'+user.uid+'/items/'+this.itemKey+'/name']: itemName,
        ['home/'+user.uid+'/items/'+this.itemKey+'/role']: itemRole,
        ['home/'+user.uid+'/items/'+this.itemKey+'/time']: firebase.database.ServerValue.TIMESTAMP,
      };

      MHA.DB.ref().update(registerData, function(error){
        if (error) {
          console.error("ERR",error);
        }
      });
    }
  }

  _languageChanged(language) {
    this.set('language',language);
  }


  _formatLabelDescription(role) {
    return role.charAt(0).toUpperCase() + role.slice(1)+' Name';
  }

  iconForRole(role) {
    return MGIconForRole(role);
  }

  newItem(name) {
    this.set('itemKey', MHA.DB.ref('items').push().key);
    this.set('itemName', name);
    return this.itemKey;
  }
}

customElements.define(MGItemEditor.is, MGItemEditor);
})();
  </script>
    </dom-module>
