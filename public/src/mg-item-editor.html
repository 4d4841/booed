<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="mg-data.html">
<link rel="import" href="mg-input.html">
<link rel="import" href="mg-clipboard-view.html">

    <dom-module id="mg-item-editor">
  <template strip-whitespace>
<style>

:host {
  display: block;
  background-size: 60%;
  background-position: center;
  @apply --layout-vertical;
  @apply --layout-flex;
  border-radius: 5px;
}

:host([nokey]) #name-editor {
  display: none;
}

#name-editor {
  margin-left: 8px;
  margin-right: 20px;
}

@media (max-width: 767px) {
}

</style>

<mg-data
  items="{{items}}"
  configurations="{{configurations}}"
></mg-data>


  <div class="horizontal layout end">
<mg-input
  id="name-editor"
  label="[[_formatLabelDescription(role)]]"
  icon="[[iconForRole(editorRole)]]"
  focused="{{focusedName}}"
  value="{{name}}"
> <paper-icon-button slot="suffix" icon="editor:insert-link"
    on-click="_onOpenItemBrowser"
  ></paper-icon-button>
</mg-input>
  </div>

  </template>
  <script>
var MGItemEditor
(function() {

MGItemEditor = class __MGItemEditor extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element) {

  static get is() { return 'mg-item-editor'; }

  static get properties() { return {
    configurations: Object,
    language: String,
    resources: { value: MHA.translations, },

    focusedName: {type: Boolean, value: false,},

    nokey: {
      type: Boolean,
      notify: true,
      reflectToAttribute: true,
      value: true,
    },

    norole: {
      type: Boolean,
      notify: true,
      reflectToAttribute: true,
      value: true,
    },

    key: {
      type: String,
      notify: true,
      observer: '_keyChanged',
    },

    /* Role of the current key (not editor's) */
    role: {
      type: String,
      observer: '_roleChanged',
    },

    name: {
      type: String,
      notify: true,
    },

    clipboardList: {
      type: Array,
      notify: true,
    },

    editing: {
      type: Boolean,
      notify: true,
    },

    me: Object,
  }}

  static get observers() { return [
    '_itemsChanged(items.*)',
    '_nameChanged(me.user, role, name)',
    '_languageChanged(configurations.language)',
  ]}

  updateChanges(path,value) {
    console.error("Subclass must override this.");
  }

  /*
  onItemSnapshot(snapshot) {
    console.error("Subclass must override this.");
  }
  */

  _pastedDataChanged(paste) {
    console.error("Subclass must override this.");
  }

  /*
  onDataError(error) {
    console.error("ERR", error);
    this._ItemReference.off('value', this.onItemSnapshot, this);
    delete this._ItemReference;
  }
  */

  _roleChanged(role) {
    console.assert(this.editorRole, 'Subclass must define editorRole property');
    if (role && role != this.editorRole) {
      this.role = undefined;
      this.set('key',undefined);
    }
    this.set('norole', this.role ? false : true);
  }

  _keyChanged(key) {
    this.set('role',undefined);
    this.set('nokey',key ? false : true);
    this.set('name', '');
  }

  _itemsChanged(change) {
    if (!this.key || !change.path.startsWith('items.'+this.key)) return;
    /* 27 = key.length + 'items.'.length + '.' */
    this.updateChanges(change.path.slice(27).split('.'), change.value);
  }

  _nameChanged(user, role, name) {

    if (!user || !role || (!this.focusedName)) {
      return;
    }

    if (name || name === "") {
      var registerData = {
        ['items/'+this.key+'/uid']: user.uid,
        ['items/'+this.key+'/name']: name,
        ['items/'+this.key+'/role']: this.role,
        ['home/'+user.uid+'/items/'+this.key+'/name']: name,
        ['home/'+user.uid+'/items/'+this.key+'/role']: role,
        ['home/'+user.uid+'/items/'+this.key+'/time']: firebase.database.ServerValue.TIMESTAMP,
      };

      MHA.DB.ref().update(registerData, function(error){
        if (error) {
          console.error("ERR",error);
        }
      });
    }
  }

  _languageChanged(language) {
    this.set('language',language);
  }


  _formatLabelDescription(role) {
    if (!role) {
      return '';
    }
    return role.charAt(0).toUpperCase() + role.slice(1)+' Name';
  }

  iconForRole(role) {
    return MGIconForRole(role);
  }

  /*
  newItem(name) {
    this.set('key', MHA.DB.ref('items').push().key);
    this.set('name', name);
    return this.key;
  }
  */

  _onOpenItemBrowser(e) {
  }
}

customElements.define(MGItemEditor.is, MGItemEditor);
})();
  </script>
    </dom-module>
