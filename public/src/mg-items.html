<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="mg-icons.html">
<link rel="import" href="mg-balloon.html">
<link rel="import" href="mg-menu.html">
<link rel="import" href="mg-item-editor.html">
<link rel="import" href="mg-thumbnail.html">


<dom-module id="mg-items">
  <template strip-whitespace>
      <custom-style>
    <style>
      :host {
        @apply --layout-horizontal;
      }

      #new-item {
        margin-left: 25px;
        width: 100px;
        padding:0;
        height:40px;
        box-shadow: 1px 1px 2px var(--app-shadow-color);
        --paper-button: {
          font-family: 'Mitr', sans-serif;
          font-size: 16px;
          background-color: tomato;
          color: white;
        }
      }

      #new-item-balloon {
        display: none;
        z-index: 10;
        margin: 0;
      }

      .items-container {
        @apply(--layout-vertical);
        padding: 20px;
        height: 100%;
      }

      .item {
        width: 100px;
        height: 100px;
        margin-bottom: 5px;
      }

      #editor {
        margin: 0 20px 20px 20px;
        width: 100%;
        height: 100%;
      }

      a {
        text-decoration: none;
      }

    </style>
      </custom-style>

    <div class="vertical layout" style="min-width:150px;height:100vh; border-right:1px dashed tomato">

      <paper-button id="new-item" on-tap="_openNewItemMenu">
        <iron-icon icon="add"></iron-icon> สร้าง
      </paper-button>

      <iron-selector class="items-container" attr-for-selected="key" selected="[[itemKey]]">
      <template is="dom-repeat" items="[[itemList]]" mutable-data>
        <mg-thumbnail
          key="[[item.key]]"
          label="[[_formatLabel(item.name)]]"
          icon="[[_formatRoleIcon(item.role)]]"
          src="[[item._src]]"
          class="item"
          on-click="_onThumbClick"
        ></mg-thumbnail>
      </template>
      </iron-selector>

    </div>


    <mg-balloon id="new-item-balloon" no-overlap vertical-align="top" dynamic-align horizontal-align="auto">
      <mg-menu selected-item="{{newItemSelected}}" menu="[[newMenu]]"></mg-menu>
    </mg-balloon>

    <mg-item-editor
      id="editor"
      me="[[me]]"
      item-key="{{itemKey}}"
    ></mg-item-editor>

    <app-route
        route="{{route}}"
        pattern="/:itemKey"
        data="{{routeData}}"
        tail="{{subroute}}">
    </app-route>

  </template>
  <script>
    class MGItems extends Polymer.Element {
      static get is() { return 'mg-items'; }
      static get properties() { return {
        selectedItem: Number,
        itemList: {
          type: Array,
          value: [],
        },
        menu: {
          type: Object,
          value: { entries: [
            {name:"products", icon:"local-mall", title:"สินค้า" },
            {name:"articles", icon:"local-library", title:"อาร์ติเคิล" },
            {name:"collections", icon:"group-work", title:"คอลเลคชั่น" },
            {name:"galleries", icon:"photo-library", title:"แกลเลอรี่" },
          ]}
        },
        newMenu: {
          type: Object,
          value: {
            entries: [
              {name:"product", icon:"local-mall", title:"สินค้า" },
              {name:"article", icon:"local-library", title:"อาร์ติเคิล" },
              {name:"collection", icon:"group-work", title:"คอลเลคชั่น" },
              {name:"gallery", icon:"photo-library", title:"แกลเลอรี่" },
            ],
          }
        },
        visible: {
          type: Boolean,
          value: false,
        },
      }}

      static get observers() { return [
        '_itemsChanged(items.*)',
        '_itemKeyChanged(itemKey)',
        '_routeDataChanged(routeData)',
        '_userChanged(me.user.uid)',
        '_visibleChanged(visible)',
//        '_onNewItemSelected(newItemSelected)',
      ]}

      _setCover(itemKey,imageKey) {
        if (!imageKey) {
          this._setPhotoKeyProperty(itemKey, '_src', 'images/logo-pumpkin-face-grayout.svg');
          return;
        }
        let thumbnail = MGAPP.get(['items',itemKey,'images',imageKey,'thumbnail']);
        if (thumbnail) {
          let uid = MGAPP.AU.currentUser.uid;
          MGAPP.registerRepresentation(thumbnail, { src: (key,src) => {
            this._setPhotoKeyProperty(itemKey, '_src', src);
          }});
        }
      }

      _formatLabel(str) {
        if (str) return str;
        return "(ไม่มีชื่อ)"
      }

      _itemsChanged(change) {
        let path = change.path.split('.');
        if (path.length < 2) return;
        let itemKey = path[1];

        if (path.length == 3 && path[2] == 'cover') {
          this.itemList.every((item,index) => {
            if (itemKey == item.key) {
              this._setCover(itemKey,change.value);
              return false;
            }
            return true;
          });
        } else if (path.length == 5 && path[4] == 'thumbnail') {
          let imageKey = path[3];
          this.itemList.every((item,index) => {
            if (itemKey == item.key &&
              imageKey == MGAPP.get(['items',itemKey,'cover'])) {
              this._setCover(itemKey,imageKey);
              return false;
            }
            return true;
          });
        }

      }

      connectedCallback() {
        super.connectedCallback();
        window.addEventListener('close-contextual-menu', this._closeSubmenu.bind(this));
        this.menu.action = this._onSelectedItemType.bind(this);
        this.newMenu.action = this._onNewItemTap.bind(this);
      }

      _visibleChanged(visible) {
        if (!visible) {
          this.set('itemKey',null);
        }
      }

      _formatRoleIcon(role) {
        return MGIconForRole(role);
      }

      _userChanged(uid) {
        this.set('itemList',[]);
        if (this._UidChangedCallback) {
          this._UidChangedCallback.ref.off('child_added', this._UidChangedCallback.cb, this);
          delete this._UidChangedCallback;
        }
        if (uid) {
          this._UidChangedCallback = {ref:MGAPP.DB.ref('home').child(uid).child('items')};
          this._UidChangedCallback.cb
           = this._UidChangedCallback.ref.on('child_added', function(snapshot) {
            let val = snapshot.val();

            if( this.itemList.every(function(item){
              /* Check if item exists */
              return item.key != snapshot.key;
            })) {
              /* New item found in snapshot, insert into item list.
               * In expected case it may already add placeholders for keeping
               * items that are being constructed.
               */
              this.unshift('itemList',{
                key: snapshot.key,
                role:val.role,
                name:val.name,
              }) - 1;
            }

            val._uid = uid;
            MGAPP.assignItem(snapshot.key,val);

            let itemRef = MGAPP.DB.ref('home')
                                  .child(uid)
                                  .child('items')
                                  .child(snapshot.key);

            /* Listen to name changes */
            itemRef.child('name').on('value', nameSnapshot => {
              this._setPhotoKeyProperty(snapshot.key, 'name', nameSnapshot.val());
            });

            /* Listen to images changes */
            itemRef.child('cover').on('value', coverSnapshot => {
                MGAPP.assignItem(snapshot.key,{cover:coverSnapshot.val()});
                this._setCover(snapshot.key, coverSnapshot.val());
            });

          },function(error){},this);
        }
      }

      _indexItem(itemKey) {
        for (let i = 0, data; data = this.itemList[i]; ++i) {
          if (data.key == itemKey) {
            return i;
          }
        }
        return -1;
      }

      _setPhotoKeyProperty(key,prop,val) {
        let idx = this._indexItem(key);
        if (idx > -1) {
          this.itemList[idx][prop] = val;
          this.notifyPath(['itemList',idx,prop]);
        }
      }

      _onThumbClick(e) {
        this.dispatchEvent(new CustomEvent('close-contextual-menu', {
          bubbles: true, composed: true, detail:{sender:this}}));
        this.set('route.path',"/"+e.model.item.key);
      }

      _onSelectedItemType(e) {
        console.log("should display only", e.model.item.name);
      }

      _onNewItemTap(e) {
        this._closeSubmenu(e);
        if (e.model.item.name == 'gallery') {
          this.$.editor.newItem('gallery','แกลเลอรี่ไม่มีชื่อ'); //XXX add date:time
        }
      }

      _itemKeyChanged(newItemId) {
        this.set('route.path', newItemId ? "/"+newItemId : "");
      }

      _routeDataChanged(routeData) {
        if (routeData.itemKey) {
          this.set('itemKey', routeData.itemKey);
        }
      }

      /*
      _onNewItemSelected(newItemSelected) {
      }
      */

      disconnectedCallback() {
        delete this.newMenu.target;
        super.disconnectedCallback();
      }

      _closeSubmenu(e) {
        if (e.detail && e.detail.sender != this) {
          this.$['new-item-balloon'].close();
        }
      }

      /* XXX implement contextual behavior */
      _openNewItemMenu(e) {
        this.dispatchEvent(new CustomEvent('close-contextual-menu', {
          bubbles: true, composed: true, detail:{sender:this}
        }));

        if (this.$['new-item-balloon'].visible) {
          this.$['new-item-balloon'].close();
          return;
        }

        this.$['new-item-balloon'].positionTarget = this.$['new-item'];
        this.$['new-item-balloon'].open();
      }
    }
    customElements.define(MGItems.is, MGItems);
  </script>
</dom-module>
