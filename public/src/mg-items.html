<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="mg-icons.html">
<link rel="import" href="mg-balloon.html">
<link rel="import" href="mg-menu.html">
<link rel="import" href="mg-item.html">
<link rel="import" href="mg-image.html">
<link rel="import" href="mg-item-image.html">


<dom-module id="mg-items">
  <template strip-whitespace>
    <style>
      :host {
        @apply --layout-horizontal;
      }

      #new-item {
        margin-left: 25px;
        width: 100px;
        padding:0;
        height:40px;
        box-shadow: 1px 1px 2px var(--app-shadow-color);
        --paper-button: {
          font-family: 'Mitr', sans-serif;
          font-size: 16px;
          background-color: tomato;
          color: white;
        }
      }

      #new-item-balloon {
        display: none;
        z-index: 10;
        margin: 0;
      }

      .items-container {
        @apply(--layout-vertical);
        padding: 20px;
        height: 100%;
      }

      .item {
        width: 100px;
        height: 130px;
        margin-bottom: 5px;
      }

      /*
      .iron-selected > * {
        border: 2px solid red;
      }
      */

      .item-thumbnail {
        display: block;
        width: 100px;
        height: 100px;
      }

      .icon-thumbnail {
        --iron-icon-width:15px;
        --iron-icon-height:15px;
        --iron-icon-fill-color: black;
        position: absolute;
        z-index:2;
        top: 5px;
        left: 5px;
      }

      .icon-thumbnail-shadow {
        --iron-icon-width:15px;
        --iron-icon-height:15px;
        --iron-icon-stroke-color: white;
        position: absolute;
        z-index:1;
        top: 5px;
        left: 5px;
      }

      #editor {
        margin-left: 20px
      }

      a {
        text-decoration: none;
      }

    </style>

    <div class="vertical layout" style="min-width:150px;height:100vh; border-right:1px dashed tomato">

      <paper-button id="new-item" on-tap="_openNewItemMenu">
        <iron-icon icon="add"></iron-icon> สร้าง
      </paper-button>

      <iron-selector class="items-container" attr-for-selected="name" selected="[[itemId]]">
      <template is="dom-repeat" items="[[itemList]]" mutable-data>
        <mg-item-image
          name="[[item.key]]"
          label="[[item.name]]"
          icon="[[_formatRoleIcon(item.role)]]"
          src="[[item.thumbnail]]"
          class="item"
          on-click="_onThumbClick"
        ></mg-item-image>
          <!--
        <paper-button name="[[item.key]]" class="item" on-click="_onThumbClick">
          <iron-icon class="icon-thumbnail" icon="[[_iconForRole(item.role)]]"></iron-icon>
          <iron-icon class="icon-thumbnail-shadow" icon="[[_iconForRole(item.role)]]"></iron-icon>
          <iron-image class="item-thumbnail" src="[[item.thumbnail]]" sizing="cover"></iron-image>
            [[item.name]]
        </paper-button>
      -->
      </template>
      </iron-selector>

    </div>


    <mg-balloon id="new-item-balloon" no-overlap vertical-align="top" dynamic-align horizontal-align="auto">
      <mg-menu selected-item="{{newItemSelected}}" menu="[[newMenu]]"></mg-menu>
    </mg-balloon>

    <mg-item
      id="editor"
      me="[[me]]"
      item-id="{{itemId}}"
      items={{items}}
      app-images="{{appImages}}"
    ></mg-item>

    <app-route
        route="{{route}}"
        pattern="/:itemId"
        data="{{routeData}}"
        tail="{{subroute}}">
    </app-route>

  </template>
  <script>
    class MGItems extends Polymer.Element {
      static get is() { return 'mg-items'; }
      static get properties() { return {
        selectedItem: Number,
        items: {
          type: Object,
          value: {},
        },
        itemList: {
          type: Array,
          value: [],
        },
        menu: {
          type: Object,
          value: { entries: [
            {name:"products", icon:"local-mall", title:"สินค้า" },
            {name:"articles", icon:"local-library", title:"อาร์ติเคิล" },
            {name:"collections", icon:"group-work", title:"คอลเลคชั่น" },
            {name:"galleries", icon:"photo-library", title:"แกลเลอรี่" },
          ]}
        },
        newMenu: {
          type: Object,
          value: {
            entries: [
              {name:"product", icon:"local-mall", title:"สินค้า" },
              {name:"article", icon:"local-library", title:"อาร์ติเคิล" },
              {name:"collection", icon:"group-work", title:"คอลเลคชั่น" },
              {name:"gallery", icon:"photo-library", title:"แกลเลอรี่" },
            ],
          }
        },
        visible: {
          type: Boolean,
          value: false,
        },
      }}

      static get observers() { return [
        '_itemIdChanged(itemId)',
        '_routeDataChanged(routeData)',
        '_userChanged(me.user.uid)',
        '_visibleChanged(visible)',
//        '_onNewItemSelected(newItemSelected)',
      ]}

      connectedCallback() {
        super.connectedCallback();
        window.addEventListener('close-contextual-menu', this._closeSubmenu.bind(this));
        this.menu.action = this._onSelectedItemType.bind(this);
        this.newMenu.action = this._onNewItemTap.bind(this);
      }

      _visibleChanged(visible) {
        if (!visible) {
          this.set('itemId',null);
        }
      }

      _formatRoleIcon(role) {
        return MGIconForRole(role);
      }

      _userChanged(uid) {
        if (uid) {
          MGFIRE.database().ref('home')
                           .child(uid)
                           .child('items')
                           .on('child_added', function(keysnap){
            if (!this.items[keysnap.key]) {
              this.items[keysnap.key] = {};
            }
            MGFIRE.database().ref('items')
                             .child(keysnap.key)
                             .once('value',function(datasnap){
              let val = datasnap.val();
              this.items[keysnap.key].name = val.name;
              this.push('itemList',{key: keysnap.key, role:val.role, name:val.name});
              let last = this.itemList.length - 1;
              let images = val.images;
              if (images) {
                let keys = Object.keys(val.images);
                if (keys.length && !images[keys[0]].uploading) {
                  MGFIRE.storage().ref('home')
                                  .child(uid)
                                  .child('images')
                                  .child(keys[0])
                                  .getDownloadURL().then(function(url){
                      this.set('itemList.'+last+".thumbnail",url);
                  }.bind(this));
                }
              }
              else {
                this.set('itemList.'+last+".thumbnail",'images/logo-pumpkin-grayout.svg');
              }

              MGFIRE.database().ref('items').child(keysnap.key).on('child_changed', function(keysnap){
                let key = keysnap.key;
                let parentKey = keysnap.ref.parent.key;
                if (key == 'name') {
                  for (let i = 0,item; item = this.itemList[i]; ++i) {
                    if (item.key == parentKey) {
                      this.set('itemList.'+i+"."+key,keysnap.val());
                      break;
                    }
                  }
                }
              }.bind(this));

            }.bind(this));
          }.bind(this));
        }
      }

      _onThumbClick(e) {
        this.dispatchEvent(new CustomEvent('close-contextual-menu', {
          bubbles: true, composed: true, detail:{sender:this}}));
        this.set('route.path',"/"+e.model.item.key);
      }

      _onSelectedItemType(e) {
        console.log("should display only", e.model.item.name);
      }

      _onNewItemTap(e) {
        this._closeSubmenu(e);
        if (e.model.item.name == 'gallery') {
          this.$.editor.newItem('gallery','แกลเลอรี่ไม่มีชื่อ'); //XXX add date:time
        }
      }

      _itemIdChanged(newItemId) {
        this.set('route.path', newItemId ? "/"+newItemId : "");
      }

      _routeDataChanged(routeData) {
        if (routeData.itemId) {
          this.set('itemId', routeData.itemId);
        }
      }

      /*
      _onNewItemSelected(newItemSelected) {
      }
      */

      disconnectedCallback() {
        delete this.newMenu.target;
        super.disconnectedCallback();
      }

      _closeSubmenu(e) {
        if (e.detail && e.detail.sender != this) {
          this.$['new-item-balloon'].style.display = "none";
        }
      }

      _willRefit() {
        this.$['new-item-balloon'].style.display = "block";
        this.$['new-item-balloon'].refit();
      }

      /* XXX addd contextual behavior */
      _openNewItemMenu(e) {
        this.dispatchEvent(new CustomEvent('close-contextual-menu', {
          bubbles: true, composed: true, detail:{sender:this}}));

        if (this.$['new-item-balloon'].style.display == "block") {
          this.$['new-item-balloon'].style.display = "none";
          return;
        }

        this.$['new-item-balloon'].positionTarget = this.$['new-item'];
        this.__WillRefitSubmenuDebouncer = Polymer.Debouncer.debounce(this.__WillRefitSubmenuDebouncer,
          Polymer.Async.timeOut.after(10),
          this._willRefit.bind(this));

      }

      addPhoto(photo) {

      }
    }
    customElements.define(MGItems.is, MGItems);
  </script>
</dom-module>
