<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="mg-badge-button.html">
<link rel="import" href="mg-menu.html">

<dom-module id="mg-profile-button">
  <template strip-whitespace>
      <custom-style>
    <style>
      .arrow {
        pointer-events: none;
        position: absolute;
        top: -4px;
      }

      /*
      #pyramid {
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 10px solid black;
        position: absolute;
        margin-top:30px;
        margin-left:10px;
      }
      */

      .photo {
        height: 200px;
        width: 200px;
        background-size: contain;
        margin: 0px;
      }

      h3  {
        padding: 0;
        margin: 0;
        padding-bottom: 20px;
      }

      .under-photo {
        background: linear-gradient(
          transparent 0,
          purple 100px);
        background-repeat: no-repeat;
        color: white;
        text-align: left;
        text-shadow: 1px 1px 3px #200020;
        max-height: 40px;
        line-height: 20px;
        height: 40px;
        width: 200px;
        z-index:1;
        display: block;
        position: absolute;
        top: 160px;
        overflow: hidden;
        padding-left: 10px;
        box-sizing: border-box;
        pointer-events: none;
      }

      #id-card {
        width:200px;
        border-radius: 5px;
        overflow: hidden;
        box-sizing: border-box;
        @apply(--layout-vertical);
        @apply(--layout-end-justified);
        position: absolute;
        top: 36px;
        right: 0;
      }

      .button {
        margin: 0;
        height: 40px;
        width: 100%;
        --paper-button: {
          @apply(--layout-horizontal);
          @apply(--layout-start-justified);
          font-family: 'Mitr', sans-serif;
          font-size: 16px;
        }
      }

      .button:not(:last-of-type) {
        border-bottom: 1px dashed tomato;
      }

      .button iron-icon {
        margin-right: 10px;
      }

      a {
        color: var(--app-primary-color);
      }
      a:link {
            text-decoration: none;
      }

    </style>
      </custom-style>

    <!--
    <dom-if id="photo-icon" if="[[image]]">
  <template>
    <div class="photo-icon" hidden$="[[!image]]"></div>
  </template>
    </dom-if>
  -->

    <!-- <div id="pyramid"></div> -->

        <dom-if id="panel" if="[[_canShowPanel(me,showPanel)]]">
      <template>
    <svg class="arrow">
      <defs id="defs2">
        <filter id="blurshadow">
          <feGaussianBlur stdDeviation="1.2" />
        </filter>
      </defs>
      <path
        transform="translate(13,31)"
        id="arrow-shadow"
        d="M 16,10 0,10 8,0 Z"
        style="opacity:0.3;fill:#000000;stroke:none;filter:url(#blurshadow);" />
    </svg>

    <paper-card id="id-card">
            <div class="under-photo">
              <h3>[[me.user.email]]<br>[[me.user.displayName]]</h3>
            </div>
            <paper-button style="padding:0;margin:0" on-tap="_openProfile">
            <iron-image
              class="photo"
              src="[[me.user.photoURL]]"
              sizing="cover"
            ></iron-image>
            </paper-button>
            <mg-menu menu="[[menu.entries.0.submenu]]"></mg-menu>
    </paper-card>

    <svg class="arrow">
      <path
        transform="translate(13,31)"
        id="arrow"
        d="M 16,10 0,10 8,0 Z"
        style="fill:#ffffff;stroke:none;" />
    </svg>
      </template>
        </dom-if>



  </template>
  <script>
  (function() {
  let memoizedTemplate;

    class MGProfileButton extends MGBadgeButton {
      static get is() { return 'mg-profile-button'; }

      static get template() {
        if (!memoizedTemplate) {
          memoizedTemplate = Polymer.DomModule.import(this.is, 'template');
          let superTemplateContents = document.importNode(MGBadgeButton.template.content, true);
          let insert = memoizedTemplate.content.querySelector('#panel');
          memoizedTemplate.content.insertBefore(superTemplateContents, insert);
        }
        return memoizedTemplate;
      }

      static get properties() { return {
        icon: {
          type: String,
          value: "pumpkin"
        },
        pathStyle: {
          type: String,
          value: "fill:tomato;fill-rule:evenodd;opacity:0.9"
        },
        showPanel: {
          type: Boolean,
          value: false,
        },
        me: {
          type: Object,
        },
        route: {
          type: Object,
          notify: true
        },
      }}

      static get observers() { return [
        '_avatarChanged(me.user.photoURL)',
        '_waitingChanged(me.waiting)',
      ]}

      _waitingChanged(waiting) {
        this.set('spinnerActive',waiting);
      }

      connectedCallback() {
        super.connectedCallback();
        window.addEventListener('close-contextual-menu', this._closeSubmenu.bind(this));

        this.addEventListener('blur', e => {
          Polymer.Async.timeOut.run(() => {
            this.showPanel = false;
          }, 300);
        },true);
      }

      _avatarChanged(photoURL) {
        if (photoURL) {
          this.icon = null;
          this.image = photoURL;
          this.$.button.style.color = "rgba(0,0,0,0)";
        }
        else {
          this.icon = "pumpkin";
          this.image = null;
          this.$.button.style.color = "var(--app-primary-color)";
          this.showPanel = false;
        }
      }

      _closeSubmenu(e) {
        if (e.detail && e.detail.sender != this) {
          this.showPanel = false;
        }
      }

      _canShowPanel(me,showPanel) {
        return me && me.user && this.showPanel;
      }

      _onButtonClick(e) {
        if (!this.me || !this.me.user) {
          this._openProfile(e);
        } else if (!this.route.path.startsWith("/user/profile")) {
          this.showPanel = !this.showPanel;
        }

        if (this.showPanel) {
          this.dispatchEvent(new CustomEvent('close-contextual-menu', {
            bubbles: true, composed: true, detail:{sender:this}}));
        }

        this.focus();
      }

      _openProfile(e) {
        this.showPanel = false;
        this.set('route.path','/user/profile');
      }

    }

    customElements.define(MGProfileButton.is, MGProfileButton);
  })();
  </script>
</dom-module>
