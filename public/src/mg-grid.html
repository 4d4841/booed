<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">

<link rel="import" href="mg-common-styles.html">
<link rel="import" href="mg-image.html">

<dom-module id="mg-grid">
  <template>
      <custom-style>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
        position: relative;
        @apply --layout-vertical;
        padding: 0;
        margin: 0;
        /*
        border: 1px solid red;
        background: yellow;
        */
      }

      .grid-image {
        position: absolute;
        overflow: hidden;
        box-sizing: border-box;
        border: 4px solid transparent;
        border-radius: 10px;
      }

      iron-list {
      }

      #grid {
      }

      mg-image {
        --mg-image: {
          box-sizing: border-box;
        };
      }

      /*
      paper-card {
        border-radius: 5px;
        overflow: hidden;
      }
      */

    </style>
      </custom-style>

      <!--
    <div style="display:block;color:blue;font-size:30px;position:fixed;top:150px;right:10px;z-index:1000">
      XXX[[lowerTriggered]]XXX
    </div>
      -->

      <!-- TODO Use iron-list with a line height equals to the max height of highest item (too prevent being pulled out as an off-screen list entry) -->
      <dom-repeat
        id="grid"
        items="[[gridItems]]"
        mutable-data>
    <template strip-whitespace>
      <!--
    <iron-image sizing="cover" style$="[[_computeItemStyle(item,unitWidth,index)]]" class="grid-image" src="[[item.photo]]"></iron-image>
      -->
      <!--
    <paper-card image="[[item.photo]]" style$="[[_computePaperCardItemStyle(item,unitWidth,index,4)]]">
    </paper-card>
      -->
      <mg-image src="[[item.photo]]" style$="[[_computeItemStyle(item,unitWidth,index,2)]]"></mg-image>
    </template>
      </dom-repeat>

    <iron-scroll-threshold
      style="display:none"
      id="scrollThreshold"
      scroll-target="document"
      lower-threshold="500"
      lower-triggered="{{lowerTriggered}}"
      on-lower-threshold="_load">
    </iron-scroll-threshold>

  </template>
  <script>

var moon_photos = [
"/moon_images/12724705_858580810930604_1171443477_n.jpg",
"/moon_images/13651703_561490057370896_707793474_n.jpg",
"/moon_images/13694754_512991945578208_711387289_n.jpg",
"/moon_images/13703037_620837414746135_1104411796_n.jpg",
"/moon_images/13704288_158713244558503_504148512_n.jpg",
"/moon_images/13712223_1738994576338593_1028075845_n.jpg",
"/moon_images/13712641_1640268749620500_1120106434_n.jpg",
"/moon_images/13721133_185764438504767_1843624085_n.jpg",
"/moon_images/13722188_1245251505494279_1948624224_n.jpg",
"/moon_images/13725540_144408085996713_2041353294_n.jpg",
"/moon_images/13725595_1203322056397483_624525082_n.jpg",
"/moon_images/13731298_149207752181508_1661966094_n.jpg",
"/moon_images/13732204_1345520995476442_1922742153_n.jpg",
"/moon_images/13739492_1101389266610989_1393103603_n.jpg",
"/moon_images/13774828_473070946196893_1435007839_n.jpg",
"/moon_images/13827365_1164883620242389_325752753_n.jpg",
"/moon_images/14026674_933338873445178_201061288_n.jpg",
"/moon_images/14032903_1733743796876282_840744895_n.jpg",
"/moon_images/14033638_960546910733985_424068452_n.jpg",
"/moon_images/14052735_318547028495745_961295517_n.jpg",
"/moon_images/14073028_1231572890221513_275253056_n.jpg",
"/moon_images/14073039_530080793855516_439662297_n.jpg",
"/moon_images/14134554_1138849726193233_1371231185_n.jpg",
"/moon_images/14134840_1307593142614792_973574659_n.jpg",
"/moon_images/14240508_331603800507024_1698486008_n.jpg",
"/moon_images/14262796_1329414080409648_745678210_n.jpg",
"/moon_images/14271985_912360312203710_353099107_n.jpg",
"/moon_images/14276601_1112394952185185_323185797_n.jpg",
"/moon_images/14278940_181302995635509_75449632_n.jpg",
"/moon_images/14334542_304426719932269_921016798453694464_n.jpg",
"/moon_images/14369060_1780460928899712_1540277902_n.jpg",
"/moon_images/14369179_138542926546813_1060242460_n.jpg",
"/moon_images/14374085_718300801650265_3910945499741421568_n.jpg",
"/moon_images/14474150_1121142921307127_3245412610392195072_n.jpg",
"/moon_images/14487165_1623440191288983_4605891961516195840_n.jpg",
"/moon_images/14487413_304907536531992_9033486606371127296_n.jpg",
"/moon_images/14504946_2180353632190200_2500874424698273792_n.jpg",
"/moon_images/14540572_314976792216614_8337012879995699200_n.jpg",
"/moon_images/14540604_1694716104182661_8513226025121873920_n.jpg",
"/moon_images/14547776_179552479153781_6299468360274935808_n.jpg",
"/moon_images/14549993_1832263596993700_8171169160311603200_n.jpg",
"/moon_images/14561747_1015403255238716_6037840676547198976_n.jpg",
"/moon_images/14561905_346174052419051_3496273863375847424_n.jpg",
"/moon_images/14562047_161234317664445_6841731294477418496_n.jpg",
"/moon_images/14564885_1867998913428881_6820435162996670464_n.jpg",
"/moon_images/14564953_591282224413500_2830672679751647232_n.jpg",
"/moon_images/14566550_1028737163922189_174218905911296000_n.jpg",
"/moon_images/14574222_1819523088270956_1322541548516147200_n.jpg",
"/moon_images/14583539_1680590508937419_3849608788319404032_n.jpg",
"/moon_images/14591071_1228017863927038_4095811801378193408_n.jpg",
"/moon_images/14591079_932099976934383_7853035486678351872_n.jpg",
"/moon_images/14591158_317558298615915_2469127838922440704_n.jpg",
"/moon_images/14596832_1808689889343672_8947087356322643968_n.jpg",
"/moon_images/14624608_1352238501476857_8352037929727557632_n.jpg",
"/moon_images/14624618_1825534837684226_3617180907904958464_n.jpg",
"/moon_images/14624857_1150577658362141_6944922324760002560_n.jpg",
"/moon_images/14659450_179369685850682_6532550544597188608_n.jpg",
"/moon_images/14677229_243346226081493_3775472842427072512_n.jpg",
"/moon_images/14693822_1787237784822387_631510211424681984_n.jpg",
"/moon_images/14709472_331845280516648_6439189740972408832_n.jpg",
"/moon_images/14712117_1168600036527500_4778626689938751488_n.jpg",
"/moon_images/14719617_1143696615726458_4102114425366904832_n.jpg",
"/moon_images/14723656_1379120372099202_7235882723858972672_n.jpg",
"/moon_images/14723741_1803274099929693_3329920232289468416_n.jpg",
"/moon_images/14727616_1866629363567804_6409096159259787264_n.jpg",
"/moon_images/14727679_1195710813853858_3129417410721873920_n.jpg",
"/moon_images/14736220_1812145492359157_3736230306064105472_n.jpg",
"/moon_images/15046965_556057884586401_1807381598899798016_n.jpg",
"/moon_images/15047045_1793140040971099_4031338969261146112_n.jpg",
"/moon_images/15056618_129293997553615_4452673306788626432_n.jpg",
"/moon_images/15056784_204615699983718_1825744001429405696_n.jpg",
"/moon_images/15057139_1160036187421487_7750506611503792128_n.jpg",
"/moon_images/15099512_1820298508183643_7056298312873279488_n.jpg",
"/moon_images/15101663_1142116092537825_7762814067923746816_n.jpg",
"/moon_images/15253279_1493339444040385_5032002431525847040_n.jpg",
"/moon_images/15253337_379162059098193_6586795423199920128_n.jpg",
"/moon_images/15305934_912918355476038_2659683937139294208_n.jpg",
"/moon_images/15306587_746288848856034_408549302219046912_n.jpg",
"/moon_images/15337168_1822892514590162_6414747880954789888_n.jpg",
"/moon_images/15337203_376545159358877_1483853403393097728_n.jpg",
"/moon_images/15338353_1846998982224929_1717503867723186176_n.jpg",
"/moon_images/15338402_1751912405132553_6175163266470248448_n.jpg",
"/moon_images/15534801_1914314398791854_732738149595217920_n.jpg",
"/moon_images/15534804_1232959680123522_7468462031935373312_n.jpg",
"/moon_images/15534861_109983122834336_5496462247909654528_n.jpg",
"/moon_images/15534909_376339152698652_3932430231826071552_n.jpg",
"/moon_images/15535155_915002075266031_4796795011486187520_n.jpg",
"/moon_images/15538836_711571959019506_9080319470932590592_n.jpg",
"/moon_images/15538948_1287867914611090_703012736774176768_n.jpg",
"/moon_images/15801844_1267771319971900_8143951084973457408_n.jpg",
"/moon_images/15801895_1621365404835398_5126298468574298112_n.jpg",
"/moon_images/15876152_363830730643207_3742782068220755968_n.jpg",
"/moon_images/15876666_1902769723288435_2360180852383547392_n.jpg",
"/moon_images/15876956_1773989119520069_4948508280176508928_n.jpg",
"/moon_images/16110683_201849890282334_697359404466438144_n.jpg",
"/moon_images/16122440_1257314130972805_1286014569650585600_n.jpg",
"/moon_images/16122448_246574392430784_465930675178962944_n.jpg",
"/moon_images/16122598_1863484790602382_5505385746841731072_n.jpg",
"/moon_images/16122712_684515488391893_623498241991770112_n.jpg",
"/moon_images/16123127_1800428263551871_7059331100950134784_n.jpg",
"/moon_images/16123772_509360745855025_8814357654102081536_n.jpg",
"/moon_images/16123773_1809260292625146_4297828366989393920_n.jpg",
"/moon_images/16123792_386069585084090_1386857532722511872_n.jpg",
"/moon_images/16228617_153947875101672_3768941421235535872_n.jpg",
"/moon_images/16228686_1814370752148785_2735947609830064128_n.jpg",
"/moon_images/16464801_1807940889469047_8650079862314237952_n.jpg",
"/moon_images/16465790_1664733280493233_3443188660302774272_n.jpg",
"/moon_images/16583198_478276182561370_2191328679907295232_n.jpg",
"/moon_images/16583666_1543517855676886_2067922007361585152_n.jpg",
"/moon_images/16584019_260176057749983_3615448343867555840_n.jpg",
"/moon_images/16584025_738588979643835_5408883131690254336_n.jpg",
"/moon_images/16584974_351644991901484_3655407156221444096_n.jpg",
"/moon_images/16585518_1872764739647424_5303481142438002688_n.jpg",
"/moon_images/16788622_1343105085728043_7877249554515492864_n.jpg",
"/moon_images/16789162_707271632778381_538987008027000832_n.jpg",
"/moon_images/16789613_221804704952243_6689831641386319872_n.jpg",
"/moon_images/16789870_1763379637311807_3663787075502604288_n.jpg",
"/moon_images/16906463_1813204642280037_4687691563583668224_n.jpg",
"/moon_images/16906637_618914451625612_2485952647455047680_n.jpg",
"/moon_images/16908788_373294626389010_1778322172297609216_n.jpg",
"/moon_images/17076157_1693568407607698_8224518684262006784_n.jpg",
"/moon_images/17076446_623247867864246_1840618443838062592_n.jpg",
"/moon_images/17076957_1233304143419670_6502936916889960448_n.jpg",
"/moon_images/17125450_474712469319479_5821807467985633280_n.jpg",
"/moon_images/17125569_1886090101672851_4212810185149775872_n.jpg",
"/moon_images/17125916_392962291074729_7371415905852456960_n.jpg",
"/moon_images/17126781_132276260631663_8438731015668629504_n.jpg",
"/moon_images/17126822_395747380792736_6733153726665588736_n.jpg",
"/moon_images/17127279_1827740797551789_6595231838480891904_n.jpg",
"/moon_images/17265359_1237358506378595_8095232557970358272_n.jpg",
"/moon_images/17265587_261775814274727_3567420645174149120_n.jpg",
"/moon_images/17265716_1897932243784073_6645126443493752832_n.jpg",
"/moon_images/17265792_1585142068180661_8923337187903143936_n.jpg",
"/moon_images/17265811_1309136022499641_7590401990329368576_n.jpg",
"/moon_images/17267352_976801245789995_2575183998938513408_n.jpg",
"/moon_images/17267434_986850241448442_4988018268447965184_n.jpg",
"/moon_images/17267620_1253585348090547_2770323608944246784_n.jpg",
"/moon_images/17267655_201692090315528_4256566337003847680_n.jpg",
"/moon_images/17267659_682638921924810_475765866818961408_n.jpg",
"/moon_images/17268276_790181534491521_4582282414620934144_n.jpg",
"/moon_images/17332384_740980182743457_4230132917830942720_n.jpg",
"/moon_images/17332701_430141670658397_2333758011715092480_n.jpg",
"/moon_images/17332831_1252873431476019_3920570049005355008_n.jpg",
"/moon_images/17332983_578169825707366_7958301978302349312_n.jpg",
"/moon_images/17333057_1621694541178910_6775403560474509312_n.jpg",
"/moon_images/17333209_253275801800403_904821898414653440_n.jpg",
"/moon_images/17334000_190272641472821_2992088451362324480_n.jpg",
"/moon_images/17437461_294933587610417_2011988957503422464_n.jpg",
"/moon_images/17438691_1315968921825201_7534945140675182592_n.jpg",
"/moon_images/17438986_1480643635299792_2908306747657551872_n.jpg",
"/moon_images/17439140_286441985118596_4135373226177986560_n.jpg",
"/moon_images/17494947_1540792549265272_3354840036267786240_n.jpg",
"/moon_images/17596368_1872294676318940_8737644422889472000_n.jpg",
"/moon_images/17661932_1320465184702574_6725075700635664384_n.jpg",
"/moon_images/17661971_1843917579195930_3336581954198831104_n.jpg",
"/moon_images/17662488_289693111465037_5451338526928928768_n.jpg",
"/moon_images/17818271_202515763570930_3025472557844267008_n.jpg",
"/moon_images/17818549_218246141993786_8816331784280080384_n.jpg",
"/moon_images/17881241_202575353578585_5503625123782983680_n.jpg",
"/moon_images/17882259_1684108928558214_6032764411750383616_n.jpg",
"/moon_images/17883044_605227933006605_5602750739886637056_n.jpg",
"/moon_images/17932342_733996056778363_1388660602943045632_n.jpg",
"/moon_images/17932445_717262861789766_8198991687872151552_n.jpg",
"/moon_images/18011359_1430292213699498_7946713576717156352_n.jpg",
"/moon_images/18012094_1158117027644809_1064137551276670976_n.jpg",
"/moon_images/18013706_120153588534966_5568081304311824384_n.jpg",
"/moon_images/18013859_280477879078581_2828204001269383168_n.jpg",
"/moon_images/18096563_794745877341859_3275025731293282304_n.jpg",
"/moon_images/18160351_672074926312530_6494129781506834432_n.jpg",
"/moon_images/18160413_1271975789581628_2479226363597291520_n.jpg",
"/moon_images/18161168_259620414504007_4156927064286429184_n.jpg",
"/moon_images/18161692_1664135846935686_2253042008421564416_n.jpg",
"/moon_images/18162102_430080980690877_6894473866534453248_n.jpg",
"/moon_images/18162212_1822968124692939_6874112732254175232_n.jpg",
"/moon_images/18252101_1044180342378772_2848983486839128064_n.jpg",
"/moon_images/18252388_695432297248116_8713542977684766720_n.jpg",
"/moon_images/18252500_104600153448179_7537902427521941504_n.jpg",
"/moon_images/18253012_430223344017774_1806001200705830912_n.jpg",
"/moon_images/18299761_479718685693121_8788363588608720896_n.jpg",
"/moon_images/18300006_108583063047831_4346465315383672832_n.jpg",
"/moon_images/18380655_122645661635838_363997889925480448_n.jpg",
"/moon_images/18382563_867845820057172_7204100025998114816_n.jpg",
"/moon_images/18443670_287871681652616_5809604250421952512_n.jpg",
"/moon_images/18443985_1820911308228290_3327590581898575872_n.jpg",
"/moon_images/18444277_218208325350174_226992573531553792_n.jpg",
"/moon_images/18513613_1667066960269751_2010962576283795456_n.jpg",
"/moon_images/18513810_1450319208358360_5692387879880228864_n.jpg",
"/moon_images/18514014_1304929869561717_6613323348833206272_n.jpg",
"/moon_images/18579809_2291338837758488_5620536272473817088_n.jpg",
"/moon_images/18580247_462558644096946_5910357457267326976_n.jpg",
"/moon_images/18580859_1771531796490381_5803779342760673280_n.jpg",
"/moon_images/18645231_103629346890465_8014473729557921792_n.jpg",
"/moon_images/18646203_1815443122117752_3221954671547514880_n.jpg",
"/moon_images/18722170_240805926402516_4871263787279187968_n.jpg",
"/moon_images/18722607_230319197471388_860786354643009536_n.jpg"];

    class MGGrid extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element) {
      static get is() { return 'mg-grid'; }

      static get properties() { return {
        unitWidth: {
          type: Number,
        },

        gridItems: {
          type: Array,
          value: [],
        },

        _sizeMap: {
          type: Object,
          value: {}
        },

        /* TODO change collisionMap to an object and only keep row with -1 */
        collisionMap: {
          type: Array,
          value: [],
          notify: true
        },

        numberOfColumns: {
          type: Number,
          value: 6,
          observer: '_numberOfColumnsChanged'
        },

      }}

      _numberOfColumnsChanged(newNumColumns) {
        if (newNumColumns == this.numberOfColumns) return;
        this._sizeMap = {};
        this.collisionMap = [];
        this.gridItems = [];
        this.$.grid.items = [];
      }

      _appendItem(anItem, rtl) {
        rtl = rtl ? true : false;

        let ew = anItem.width ? Math.ceil(anItem.width * this.numberOfColumns) : anItem.w;
        let eh = anItem.height ? Math.ceil(anItem.height * this.numberOfColumns) : anItem.h;
        let szmpKey = ew+','+eh;

        anItem.w = ew;
        anItem.h = eh;

        if (ew > this.numberOfColumns) {
          console.log(anItem, "is too wide").
          return;
        }

        let szmp = this._sizeMap;
        let clmp = this.collisionMap;

        if (! szmp[szmpKey]) {
          szmp[szmpKey] = 1;
        }

        let py1 = szmp[szmpKey];
        let py2 = py1 + eh - 1;
        let px2 = rtl ? this.numberOfColumns : ew;
        let px1 = rtl ? px2 - ew + 1 : 1;

        seeking:
        while (true) {
          while (px2 <= this.numberOfColumns && px1 >= 1) {

            while (clmp.length < py2) {
              let r = [];
              while (r.length < this.numberOfColumns) r.push(0);
              this.push('collisionMap',r);
            }

            let hasCollision = false;
            test_collision:

            for (let ri = py1; ri <= py2; ++ri) {
            for (let ci = px1; ci <= px2; ++ci) {
              if (clmp[ri-1][ci-1] != 0) {
                hasCollision = true;
                break test_collision;
              }
            }
            }

            if (!hasCollision) {
              szmp[szmpKey] = py1;
              anItem.x = px1;
              anItem.y = py1;

              /* Fill collision map */
              for (let ri = py1; ri <= py2; ++ri) {
              for (let ci = px1; ci <= px2; ++ci) {
                clmp[ri-1][ci-1] = ri+ci;
              }
              }
              clmp[py1-1][px1-1] = anItem;

              break seeking;
            }

            if (rtl) {
              --px1;
              --px2;
            } else {
              ++px1;
              ++px2;
            }
          }

          px2 = rtl ? this.numberOfColumns : ew;
          px1 = rtl ? px2 - ew + 1 : 1;
          ++py1;
          ++py2;
        }

        this.push('gridItems',anItem);
        this.style.height = (this.collisionMap.length * this.unitWidth)+"px";
        //this.$.grid.push('items', anItem);
        //this.$.griditems.push(anItem);
      }

      static get observers() { return [
      ]}

      connectedCallback() {
        super.connectedCallback();
        this.addEventListener('iron-resize', this._onResizeEvent);

        this.photoIndex = 0;
//        this._load();
//        this._appender()
      }

      _load(what) {

        if (this.collisionMap.length > 3000) return;

        if (this._loading) this._loading.cancel();
        this._loading = Polymer.Debouncer.debounce(this._loading,
                  Polymer.Async.timeOut.after(1000),
                  this._loadSome.bind(this));
      }

      _getIndex() {
        this.photoIndex+=getRandomInt(1,5);
        return this.photoIndex;
      }

      _loadSome() {
        for (let i = 0; i < 2; i++) {

          for (let j = 0; j < 5; j++)
          this._appendItem({
            x: 0,
            y: 0,
            w: getRandomInt(1,3),
            h: getRandomInt(1,3),
            photo: moon_photos[this._getIndex()%moon_photos.length],
          });

          this._appendItem({
            x: 0,
            y: 0,
            w: getRandomInt(2,7),
            h: getRandomInt(2,7),
            photo: moon_photos[this._getIndex()%moon_photos.length],
          });

          for (let j = 0; j < 5; j++)
          this._appendItem({
            x: 0,
            y: 0,
            w: getRandomInt(1,3),
            h: getRandomInt(1,3),
            photo: moon_photos[this._getIndex()%moon_photos.length],
          },true);

          this._appendItem({
            x: 0,
            y: 0,
            w: getRandomInt(2,7),
            h: getRandomInt(2,7),
            photo: moon_photos[this._getIndex()%moon_photos.length],
          },true);
        }
        this.$.scrollThreshold.clearTriggers();
      }


      _appender() {

        if (this.gridItems.length > 100) return;

        for (let i = 0; i < 1; i++) {

          this._appendItem({
            x: 0,
            y: 0,
            w: getRandomInt(1,2),
            h: getRandomInt(1,2),
            photo: moon_photos[getRandomInt(0,moon_photos.length)],
          });
          this._appendItem({
            x: 0,
            y: 0,
            w: getRandomInt(2,5),
            h: getRandomInt(2,5),
            photo: moon_photos[getRandomInt(0,moon_photos.length)],
          });

        }
        this._appending = Polymer.Debouncer.debounce(this._appending,
                  Polymer.Async.timeOut.after(1000),
                  this._appender.bind(this));
      }

      disconnectedCallback() {
        this.removeEventListener('iron-resize', this._onResizeEvent);
        super.disconnectedCallback();
      }

      _onResizeEvent(e) {
          this.unitWidth = this.offsetWidth/this.numberOfColumns;
          let maxH = 1,
              maxW = 1;
          for (let i = 0, it; it = this.gridItems[i]; ++i) {
            let mh = it.y + it.h - 1;
            if (mh > maxH) maxH = mh;
            let mw = it.x + it.w - 1;
            if (mw > maxW) maxW = mw;
          }
//          this.style.height = (maxH * this.unitWidth)+"px";
//          this.style.width = (maxW * this.unitWidth)+"px";
      }

      _computePaperCardItemStyle(item, blockSize, index, inset) {
        return this._computeItemStyle(item, blockSize, index, inset);
      }

      _computeItemStyle(item, blockSize, index, inset) {
        if (!inset) inset = 0;
        if (!blockSize) blockSize = this.offsetWidth/this.numberOfColumns;
        let unit = "px";
        let x = item.x - 1;
        let y = item.y - 1;
        let ret = "display: block;position: absolute";
        ret += ";width: "+ Math.floor(blockSize * item.w - inset * 2) + unit;
        ret += ";height: "+ Math.floor(blockSize * item.h - inset * 2) + unit;
        ret += ";left: "+ Math.floor(blockSize * x + inset) + unit;
        ret += ";top: "+ Math.floor(blockSize * y + inset) + unit;
        return ret;
      }

    }

    customElements.define(MGGrid.is, MGGrid);
  </script>
</dom-module>
