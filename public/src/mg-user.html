<!DOCTYPE html>
<!--
 .................................................................................................
:::BSDB'::BSDB'::BSDB':::::BSDB':::BSDBS'::BSDBS'::BSDB'::::BSD'::BSDBS'::BSDBS'::BSDB'::::::BSD'::
::BSDBSD BSDBSD :.BSDBS':BSDBS .:BSD ..BSD  ...BSD 'BSDBS':BSD .BSD ..BSD  ...BSD :BSDBS'::BSDB .::
::COPYRIGHT2017 ::.BS BSDB .BS :BSD .::.BSD :::.BSD :BS .BSDB .BSD .:::BSD ::::BSD :BS BSDB BS .:::
:::BSDSTYLEBSD .:::BS  BS .:BS :BSD ::::BSD ::::BSD :BS ::BSD :BSD :::::...::::BSD :BS :BS  BS ::::
::::.LICENSE .::::BSD .:..::BS 'BSD ::::BSD ::::BSD :BS :::BS :BSD ::BSDBS'::::BSD :BS ::..:BS ':::
:::::::BSD .::::BSDB .::::::BSD 'BSD'::BSD .:::BSD .BSD :::BSD':BSD'::.BSD :::BSD .BSD :::::BSDB'::
::::::::B .::::::BS .:::::::.BSD ::BSDBS .:BSDBS  :BSD .::::BSD :.BSDBS BS BSDB .:BSD .:::::.BS .::
`::::::::.::::::::..::::::::::...:::.....:::.....:::...::::::...:::.............:::...::::::::..::'
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="mg-profile.html">
<link rel="import" href="mg-items.html">

<dom-module id="mg-user">
  <template strip-whitespace>
      <custom-style>
    <style is="custom-style" include="mg-common-styles iron-flex iron-flex-alignment">
      :host {
      }

      @media (max-width: 767px) {
      }

    </style>
      </custom-style>

    <iron-pages
      selected="[[page]]"
      attr-for-selected="name"
      selected-attribute="visible"
      fallback-selection="404"
      >
      <mg-profile
        name="profile"
        me="{{me}}"
      ></mg-profile>
      <div name="order">
        show order<br>
      </div>
      <mg-items
        id="items"
        name="items"
        me="[[me]]"
        route="{{subroute}}"
        app-images="{{appImages}}"
      ></mg-items>
      <div name="store">
        show store
      </div>
      <div name="inbox">
        show inbox
      </div>
      <div name="help">
        <center> <h2>Aide-toi, le ciel t'aidera.</h2> </center>
      </div>
    </iron-pages>

    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}">
    </app-route>

  </template>
  <script>
  (function(){
    var _MGUserAppMenu = { selected: "", entries: [
            { name:"profile", path:"/user/profile", icon:"face", title:"‡πÇ‡∏û‡∏£‡πÑ‡∏ü‡∏•‡πå"},
            { name:"order", path:"/user/order", icon:"credit-card", title:"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"},
            { name:"items", path:"/user/items", icon:"widgets", title:"‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°",
              submenu: { entries:[
                  { name:"products", path:"/user/items/products", icon:"local-mall", title:"‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" },
                  { name:"articles", path:"/user/items/articles", icon:"local-library", title:"‡∏≠‡∏≤‡∏£‡πå‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏¥‡∏•" },
                  { name:"collections", path:"/user/items/collections", icon:"group-work", title:"‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Ñ‡∏ä‡∏±‡πà‡∏ô" },
                  { name:"galleries", path:"/user/items/galleries", icon:"photo-library", title:"‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà" },
              ]}
            },
            { name:"store", path:"/user/store", icon:"store", title:"‡∏£‡πâ‡∏≤‡∏ô"},
            { name:"inbox", path:"/user/inbox", icon:"inbox", title:"‡∏≠‡∏¥‡∏ô‡∏ö‡∏≠‡∏Å‡∏ã‡πå"},
            { name:"help", icon:"help", title:"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠",
              submenu: { entries:[
                  { name:"tos", path:"/about/tos", icon:"info", title:"‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£", },
                  { name:"policy", path:"/about/policy", icon:"info", title:"‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß"},
              ]}
            },
          ]};

    var _MGUserMenu = { entries: [
            { name: "user-menu",
              icon: "account-box",
              submenu: { entries:[
                { name: "profile", path:"/user/profile", icon:"face", title:"‡πÇ‡∏û‡∏£‡πÑ‡∏ü‡∏•‡πå"},
                { name: "signout",
                  icon: "local-cafe",
                  color: "tomato",
                  title: "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"},
              ]}
            }
          ]};


    var _MGUserAppSignInMenu = { entries: [
            { name: "profile", path: "/user/profile", icon: "lock", title: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"},
            { name: "help", icon: "help", title: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠",
              submenu: { entries: [
                  { name: "tos", path: "/about/tos", icon: "info", title: "‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£", },
                  { name:"policy", path:"/about/policy", icon:"info", title:"‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß" },
              ]}
            },
          ]};

    class MGUser extends Polymer.Element {
      static get is() { return 'mg-user'; }

      static get properties() { return {
        /*
        route: {
          type: Object,
          notify: true
        },
        */

        route: Object,

        subroute: {
          type: Object,
          notify: true
        },

        routeData: {
          type: Object,
          notify: true
        },

        page: {
          type: String,
          reflectToAttribute: true,
          notify: true,
          observer: '_pageChanged'
        },

        me: {
          type: Object,
          notify: true,
        },

        menu: {
          type: Object,
          notify: true,
        },

        userMenu: {
          type: Object,
          notify: true
        },

        visible: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        },
      }}

      static get observers() { return [
        '_routeDataChanged(routeData)',
        '_userChanged(me.user)',
        '_visibleChanged(visible, menu, me)',
        '_selectedChanged(menu.selected)',
      ]}

      _visibleChanged( visible , menu, me) {
        if (visible && menu && me) {
          if (this.me.user) {
            this.set('menu', _MGUserAppMenu);
          }
          else {
            this.set('menu', _MGUserAppSignInMenu);
          }
        }
      }

      _setMenu(menu) {
        if (this.visible) {
          if (this.menu && menu) {
            menu.selected = this.menu.selected;
          }
          this.set('menu', menu);
        }
      }

      _userChanged(user) {
        if (user) {
          _MGUserMenu.entries[0].title = this.me.user.email;
          _MGUserMenu.entries[0].submenu.action = this._onUserMenu.bind(this);
          this.set('userMenu', _MGUserMenu);

          this._setMenu(_MGUserAppMenu);
        } else {
          this._setMenu(_MGUserAppSignInMenu);
          this.set('userMenu', { entries: [
            { action:this._signGoogle.bind(this), name: "profile", icon: "google", title: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏π‡πÄ‡∏Å‡∏¥‡πâ‡∏•"},
          ]});
        }
      }

      _signGoogle(){
        console.log("sign g");
      }

      _selectedChanged(selected) {
        if (this.visible) {
          for(let i = 0; i < this.menu.entries.length; ++i) {
            if (this.menu.entries[i].name == selected) {

              this.set('routeData.page', selected);
              this.set('page', selected);
              return;
            }
          }
          this.set('page', 'profile');
        }
      }

      _routeDataChanged( routeData ) {
        if (this.visible) {
          this.set('menu.selected', routeData.page || 'profile');
        }
      }

      _pageChanged( pg ) {
        this.dispatchEvent(new CustomEvent('change-section', {
          bubbles: true,
          composed: true,
          detail: {title: pg && pg[0].toUpperCase() + pg.slice(1)}
         }));
      }

      _onUserMenu (e) {
        MGFIRE.auth().signOut();
      }

      /*
      _visualChanged(visible,menu) {
        if (this.visible) {
          this.dispatchEvent(new CustomEvent('change-section', {
            bubbles: true, composed: true, detail: {title: 'User : üëª', menu:this.menu}}));
        }
      }
      */
    }

    customElements.define(MGUser.is, MGUser);
  })();
  </script>
</dom-module>
