<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="mg-input.html">
<link rel="import" href="mg-button.html">
<link rel="import" href="mg-image.html">

<dom-module id="mg-user">
  <template strip-whitespace>
      <custom-style>
    <style is="custom-style" include="mg-common-styles mg-input mg-button iron-flex iron-flex-alignment">
      :host {
        @apply --layout-vertical;
        @apply --layout-center;
      }

      mg-input {
        width: 180px;
        margin:10px;
      }

      mg-button {
        height:40px;
      }

      a:link {
            text-decoration: none;
      }

      mg-button > * {
        font-family: 'Athiti', sans-serif;
        font-size: 18px;
        font-weight: 500;
        padding: 8px 44px;
        background-color: white;
      }

      mg-button > *:active {
        background-color: #000;
        color: white;
      }

      mg-button > *:focus {
        background-color: azure;
        color: #202020;
      }

      mg-button.single-button,
      mg-button.upper-button,
      mg-button.lower-button {
        @apply(--layout-vertical);
        padding:0;
        margin:0;
      }

      mg-button.single-button >*,
      mg-button.upper-button >*,
      mg-button.lower-button >* {
        border-radius: 5px;
        min-width:200px;
        padding:0;
        height:40px;
        box-shadow: 1px 1px 2px var(--app-shadow-color);
      }

      mg-button.upper-button >* {
        border-bottom: 0px;
        border-radius: 5px 5px 0 0 ;
      }

      mg-button.lower-button >* {
        border-top: 1px dotted black;
        border-radius: 0 0 5px 5px;
      }

      mg-button#loginBB >* {
        border-radius: 5px 0 0 5px;
        height:40px;
        box-shadow: 1px 1px 2px var(--app-shadow-color);
        border-right: none;
      }

      mg-button#loginGG >* {
        border-radius: 0 5px 5px 0;
        width:40px;
        height:40px;
        box-shadow: 1px 1px 2px var(--app-shadow-color);
        background-color:tomato;
      }

      mg-button >*:active {
        background-color:#202020;
        color: white;
      }

      mg-button#loginGG >*:active {
        background-color:orange;
      }

      input#loginButton {
        line-height: 10px; /* adjust text into the center */
      }

      .loginButtons {
        margin-top:20px;
      }

      .main-frame {
        width:240px;
        @apply(--layout-vertical)
        transition: opacity 0.5s;
        background-color: white;
        box-shadow: 1px 1px 5px var(--app-shadow-color);
       /* max-width:300px; */
        border-radius: 10px;
        padding:20px;
        z-index: 1;
        box-sizing: border-box;
      }

      #home-button {
        width: 220px;
        height: 40px;
        background-size: 90%;
        background-repeat: no-repeat;
        background-position: center;
        background-image: url(/images/logo-bounce-in.svg);
      }

      #home-button[state=waiting] {
        display: none;
      }

      .info-button {
        --paper-icon-button: {
          width: 32px;
          height: 32px;
        };
      }

      .main-info {
        width:220px;
        box-sizing: border-box;
        @apply(--layout-vertical)
        transition: opacity 0.5s;
        box-shadow: 1px 1px 3px var(--app-shadow-color);
        border-radius: 5px;
        border-radius: 0 0 5px 5px;
        background: var(--booed-contents-background);
        z-index: 0;
        top:10px;
        position:relative;
        @apply(--layout-end-justified);
        margin-top:-35px;
        padding: 0px;
        transition: background-color 0.5s, max-height 0.5s ease-in;
        max-height: 50px;
        overflow: hidden;
      }

      .main-info[expand] {
        max-height: 1000px;
        background: white;
      }

      h3  {
        padding: 0;
        margin: 0;
        padding-bottom: 20px;
      }

      .avatar {
        border-radius: 10px;
        height: 200px;
        width: 200px;
        background-size: cover;
        margin-top: 0px;
      }

      .under-photo {
        /*background: rgba(0,0,0,0.5);*/
        background: linear-gradient(
          transparent 0,
          purple 100px);
        background-repeat: no-repeat;
        color: white;
        text-align: left;
        text-shadow: 1px 1px 3px #200020;
        max-height: 40px;
        line-height: 20px;
        height: 40px;
        width: 200px;
        max-width: 200px;
        border-radius: 0 0 10px 10px;
        z-index:1;
        display: block;
        position: absolute;
        margin-top: -40px;
        overflow: hidden;
        padding-left: 10px;
        box-sizing: border-box;
      }

      @media (max-width: 767px) {
      }

    </style>
      </custom-style>

      <div class="center vertical layout main-frame">
        <a href="/" class="center vertical layout">
          <paper-button id="home-button" alt="home" title="home" state$="[[state]]"></paper-button>
        </a>
    <iron-pages id="pages" selected="[[state]]" attr-for-selected="state" class="center vertical layout">
      <div state="waiting" class="center vertical layout">
        <img src="images/logo-bounce.svg">
      </div>
      <div state="init" class="center vertical layout">
        <!-- Begin: init -->
          <dom-if if="[[!me.User.email]]">
        <template>
          <!-- Begin: login panel -->
            <h3>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>

                <mg-input>
              <input value="{{accountEmail::input}}" type="email" id="accountEmail" name="accountEmail" pattern=".{2,50}"
                  placeholder="email" autofocus
                  aria-labelledby="accountEmailLabel accountInfoHeading">
              <mg-md-decorator error-message="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•" aria-hidden="true">
                <label id="accountEmailLabel"><iron-icon icon="mail"></iron-icon> ‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                <mg-underline></mg-underline>
              </mg-md-decorator>
                </mg-input>

                <mg-input>
              <input value="{{accountPassword::input}}" type="password" id="accountPassword" name="accountPassword" pattern=".{2,50}"
                  placeholder="‡∏û‡∏≤‡∏™‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î" autofocus
                  aria-labelledby="accountPasswordLabel accountInfoHeading">
              <mg-md-decorator error-message="‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏≤‡∏™‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î" aria-hidden="true">
                <label id="accountPasswordLabel"><iron-icon icon="key"></iron-icon> ‡∏û‡∏≤‡∏™‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î</label>
                <mg-underline></ball-underline>
              </mg-md-decorator>
                </mg-input>

              <div class="loginButtons layout horizontal center center-justified">
                  <mg-button id="loginBB" class="layout vertical center">
                  <input id="loginButton" type="submit" class="submit layout" on-click="_logIn" value="‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö">
                  </mg-button>

                  <mg-button id="loginGG" class="center justified vertical layout" style="padding:0;">
                  <a style="width:40px;margin:0;padding:0;" on-click="_googleSignIn"><iron-icon style="margin-top:8px;color:white" icon="google" slot="prefix"></iron-icon></a>
                  </mg-button>
              </div>
          <!-- End: login panel -->
        </template>
          </dom-if>

          <dom-if if="[[me.User.email]]">
        <template>
          <!-- begin: user panel -->
            <div style="padding-bottom:20px;">
              <mg-image class="avatar" src="[[me.User.photoURL]]"></mg-image>
              <div class="under-photo">
                <h3>[[me.User.email]]<br>[[me.User.displayName]]</h3>
              </div>
            </div>

                  <mg-button class="single-button layout vertical center">
                  <button on-click="_signOut"><iron-icon icon="coffee" style="color:tomato"></iron-icon> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                  </mg-button>
          <!-- End: user panel -->
        </template>
          </dom-if>
        <!-- End: init -->
      </div>
      <div state="welcome" class="center end-justified vertical layout">
        <h3>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡πà‡∏∞</h3>
          <dom-if if="[[response]]">
        <template>
        <p style="padding:0;margin:0;margin-bottom:10px">[[response.successMessage]]</p>
        </template>
          </dom-if>

            <div style="padding-bottom:20px;">
              <mg-image class="avatar" src="[[me.User.photoURL]]"></mg-image>
              <div class="under-photo">
                <h3>[[me.User.email]]<br>[[me.User.displayName]]</h3>
              </div>
            </div>

                  <mg-button class="single-button layout vertical center">
                  <button on-click="_signOut"><iron-icon icon="coffee" style="color:tomato"></iron-icon> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                  </mg-button>

      </div>
      <div state="error" class="center vertical layout">
        <h3>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
        <p style="padding:0;margin:0;margin-bottom:10px">[[response.errorMessage]]</p>

                  <a href="/">
                  <mg-button class="single-button layout vertical center">
                  <button><iron-icon icon="error" style="color:tomato"></iron-icon> ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
                  </mg-button>
                  </a>
        <p style="text-align:center;margin:10px;">‡∏´‡∏£‡∏∑‡∏≠<a href="/contact">‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏ó‡∏£‡∏≤‡∏ö‡∏ó‡∏≤‡∏á</a> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç<br>‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏¥‡πà‡∏á‡∏Ñ‡πà‡∏∞</p>

      </div>
    </iron-pages>
      </div>
      <div on-click="_toggleInfo" class="center vertical end-justified layout main-info" expand$="[[expand]]" hidden="[[_shouldHideInfoPanel(me.User.email,state)]]">
        <p style="padding: 20px 10px 0 10px;text-align: center">
          <br>
          ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏î‡πâ‡∏ß‡∏¢ <a href="https://accounts.google.com/SignUp">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏π‡πÄ‡∏Å‡∏¥‡∏•</a> ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Å‡∏î<br>
          <iron-icon style="color:tomato;--iron-icon-width:20px;" icon="google"></iron-icon> <br>(‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
          <br><br>
          ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
          ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏ô‡πÉ‡∏à
          ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏µ‡πÄ‡∏à‡πâ‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô
        </p>
        <iron-icon style="display:block;--iron-icon-width:20px" icon="help"></iron-icon>
        <!--<paper-icon-button class="info-button" icon="help"></paper-icon-button>-->
      </div>

    <app-route
        active="{{routeActive}}"
        data="{{routeData}}"
        route="[[route]]"
        pattern="/:state">
    </app-route>
  </template>
  <script>
    class MGUser extends Polymer.Element {
      static get is() { return 'mg-user'; }

      static get properties() { return {

        route: {
          type: Object,
          notify: true
        },

        state: {
          type: String,
          reflectToAttribute: true,
          value: 'init'
        },

        menu: {
          type: Array,
        },

        expand: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        },

        me: {
          type: Object,
          value: {},
          notify: true,
        },

        admin: {
          type: Boolean,
          value: false
        },

        visible: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        },

      }}

      static get observers() { return [
        '_appInitialized(firebaseApp)',
        '_updateState(routeActive, routeData)',
        '_visualChanged(visible,menu)',
      ]}

      _visualChanged(visible,menu) {
        if (this.visible) {
          this.dispatchEvent(new CustomEvent('change-section', {
            bubbles: true, composed: true, detail: {title: 'User : üëª', menu:this.menu}}));
        }
      }

      _appInitialized(firebaseApp) {
        if (firebaseApp) {
          this.__validWaiting = true;
          firebaseApp.auth().onAuthStateChanged(this._onAuthStateChanged.bind(this));
        }
      }

      _onAuthStateChanged(user) {
        console.log("_onAu");
        this.set('me.User', user);
        if (user) {
          /*
          firebase.database().ref('admins/'+auth.uid).once('value').then(this._onAdminInfo.bind(this));
          firebase.database().ref('home/'+auth.uid+"/registration").once('value').then(this._onUserRegistration.bind(this));
          */
          /*
          if (user.photoURL) {
            this.notifyPath('user.photoURL');
          }
          */
          this._pushState("welcome");
          this.menu = [
            {name:"profile", icon:"face", title:"‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"},
            {name:"order", icon:"credit-card", title:"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"},
            {name:"products", icon:"local-mall", title:"‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"},
            {name:"store", icon:"store", title:"‡∏£‡πâ‡∏≤‡∏ô"},
            {name:"inbox", icon:"inbox", title:"‡∏≠‡∏¥‡∏ô‡∏ö‡∏≠‡∏Å‡∏ã‡πå"},
            {name:"help", icon:"help", title:"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠"},
            {name:"policy", icon:"info", title:"‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß"},
          ];
        } else {
          console.log("no user");
          this._pushState("init");
          this.menu = [
            {name:"new-releases", icon:"lock", title:"‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"},
            {name:"new-releases", icon:"info", title:"‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß"},
          ];
        }
      }

      _shouldHideInfoPanel(email,state) {
        return email || state == "waiting";
      }

      _googleSignIn(e) {
        this._pushState('waiting');

        this.firebaseApp.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(
          function() {
            var provider = new firebase.auth.GoogleAuthProvider();
            return firebase.auth().signInWithRedirect(provider);
          })
          .catch(function(error) {
            var errorCode = error.code;
            var errorMessage = error.message;
            console.log("Error", error);
          });
      }

      _pushState(state) {
        console.log("push", state);
        if (!this.visible) return;
        this.set('route.path', "init");
        this._validState = state;
        this.set('route.path', state);
      }

      _updateState(active, routeData) {

        if (active && routeData) {
          let state = routeData.state;

          if (state == 'waiting' && this.__validWaiting) {
            this.state = state;
            this.__validWaiting = false;
            return;
          }

          if (this._validState === state) {
            this.state = state;
            this._validState = '';
            return;
          }
        }
        this.state = 'init';
      }

      _signOut(e) {
        this.firebaseApp.auth().signOut();
        this._pushState("init");
      }

      _calculateAvatarStyle(url) {

      }
      _toggleInfo(e) {
        this.expand = !this.expand;
      }


    }

    customElements.define(MGUser.is, MGUser);
  </script>
</dom-module>
